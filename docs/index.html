<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0c0a09">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>NAGOMI æˆ°æƒ…å®¤</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; background: #0c0a09; -webkit-tap-highlight-color: transparent; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #1c1917; }
        ::-webkit-scrollbar-thumb { background: #44403c; border-radius: 2px; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
const { useState, useEffect, useRef } = React;

// Simple SVG Icon Components
const Icon = ({ d, size = 24, className = '' }) => (
  <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d={d}/></svg>
);
const Camera = ({ size, className }) => <Icon size={size} className={className} d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z M12 17a4 4 0 1 0 0-8 4 4 0 0 0 0 8z" />;
const Calculator = ({ size, className }) => <Icon size={size} className={className} d="M4 2h16a2 2 0 0 1 2 2v16a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2z M8 6h8" />;
const RotateCcw = ({ size, className }) => <Icon size={size} className={className} d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8 M3 3v5h5" />;
const Settings = ({ size, className }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>);
const Zap = ({ size, className }) => <Icon size={size} className={className} d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" />;
const BookOpen = ({ size, className }) => <Icon size={size} className={className} d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z" />;
const X = ({ size, className }) => <Icon size={size} className={className} d="M18 6L6 18 M6 6l12 12" />;
const RefreshCw = ({ size, className }) => <Icon size={size} className={className} d="M23 4v6h-6 M1 20v-6h6" />;
const TrendingUp = ({ size, className }) => <Icon size={size} className={className} d="M23 6l-9.5 9.5-5-5L1 18 M17 6h6v6" />;
const DollarSign = ({ size, className }) => <Icon size={size} className={className} d="M12 1v22 M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 1 1 0 7H6" />;
const Utensils = ({ size, className }) => <Icon size={size} className={className} d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2 M7 2v20" />;
const Plus = ({ size, className }) => <Icon size={size} className={className} d="M12 5v14 M5 12h14" />;
const Minus = ({ size, className }) => <Icon size={size} className={className} d="M5 12h14" />;
const Check = ({ size, className }) => <Icon size={size} className={className} d="M20 6L9 17l-5-5" />;
const LayoutDashboard = ({ size, className }) => <Icon size={size} className={className} d="M3 3h7v9H3z M14 3h7v5h-7z M14 12h7v9h-7z M3 16h7v5H3z" />;
const HistoryIcon = ({ size, className }) => <Icon size={size} className={className} d="M12 8v4l3 3 M3.05 11a9 9 0 1 1 .5 4m-.5 5v-5h5" />;
const Droplets = ({ size, className }) => <Icon size={size} className={className} d="M7 16.3c2.2 0 4-1.83 4-4.05 0-1.16-.57-2.26-1.71-3.19S7.29 6.75 7 5.3c-.29 1.45-1.14 2.84-2.29 3.76S3 11.1 3 12.25c0 2.22 1.8 4.05 4 4.05z" />;
const Clock = ({ size, className }) => <Icon size={size} className={className} d="M12 22c5.52 0 10-4.48 10-10S17.52 2 12 2 2 6.48 2 12s4.48 10 10 10z M12 6v6l4 2" />;
const PenTool = ({ size, className }) => <Icon size={size} className={className} d="M12 19l7-7 3 3-7 7-3-3z" />;
const Timer = ({ size, className }) => <Icon size={size} className={className} d="M10 2h4 M12 14l3-3 M12 22a8 8 0 1 0 0-16 8 8 0 0 0 0 16z" />;
const Trophy = ({ size, className }) => <Icon size={size} className={className} d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6 M18 9h1.5a2.5 2.5 0 0 0 0-5H18 M4 22h16 M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20 7 22 M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20 17 22 M18 2H6v7a6 6 0 0 0 12 0V2Z" />;
const Target = ({ size, className }) => <Icon size={size} className={className} d="M12 22c5.52 0 10-4.48 10-10S17.52 2 12 2 2 6.48 2 12s4.48 10 10 10z M12 18a6 6 0 1 0 0-12 6 6 0 0 0 0 12z M12 14a2 2 0 1 0 0-4 2 2 0 0 0 0 4z" />;
const User = ({ size, className }) => <Icon size={size} className={className} d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2 M12 11a4 4 0 1 0 0-8 4 4 0 0 0 0 8z" />;
const Coins = ({ size, className }) => <Icon size={size} className={className} d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2z M12 6v6l4 2" />;
const Share = ({ size, className }) => <Icon size={size} className={className} d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8 M16 6l-4-4-4 4 M12 2v13" />;
const ImageIcon = ({ size, className }) => <Icon size={size} className={className} d="M5 3h14a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z M8.5 10a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3z M21 15l-5-5L5 21" />;
const Download = ({ size, className }) => <Icon size={size} className={className} d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4 M7 10l5 5 5-5 M12 15V3" />;

const VERCEL_API_URL = "https://eatawarescheduler.vercel.app/api/analyze";
const PRESET_SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ57HSiS9fzVpSA6rEhhWJNMhgsxJce-wq0_qBSXx3AYdngzJGUlqszgqgfjdyt3gBYApXZewmhWudc/pub?gid=0&single=true&output=csv";
const DEFAULT_SETTINGS = { mealPrice: 1518, calorieGoal: 2500, liquidGoal: 1000 };
const CATEGORY_MAP = { 'Sashimi': 'ç¾åˆ‡åˆºèº«', 'Sushi': 'å£½å¸æ‰‹å·', 'Kobachi': 'æ‡·çŸ³å°ç¼½', 'Yakimono': 'è·äººçƒ¤ç‰©', 'Agemono': 'ç‚¸ç‰©å¤©å©¦ç¾…', 'Soup': 'æ¹¯å“/é‹ç‰©', 'Steamed Dish': 'è’¸ç‰©', 'Cooked Dish': 'ç†±èœ/éµæ¿', 'Drink': 'é£²å“é…’æ°´', 'Dessert': 'ç²¾ç·»ç”œé»' };
const DEFAULT_MENU_DB = [
  { category: 'Sashimi', name: 'é®­é­š (Salmon)', price: 70, restaurantPrice: 120, calories: 55, ml: 0, desc: 'ç¾é»ç¾åˆ‡çš„åŸºæœ¬é­šç¨®' },
  { category: 'Sashimi', name: 'ç´…é­½ (Amberjack)', price: 80, restaurantPrice: 150, calories: 45, ml: 0, desc: 'é…åˆæ™‚ä»¤ä¾›æ‡‰çš„é­šç¨®' },
  { category: 'Sushi', name: 'ç‚™ç‡’å¹²è²æ¡å£½å¸', price: 100, restaurantPrice: 180, calories: 45, ml: 0, desc: 'ç”Ÿé£Ÿç´šå¹²è²ï¼Œé®®ç”œ' },
  { category: 'Yakimono', name: 'é¦™é­šå§¿ç‡’', price: 180, restaurantPrice: 280, calories: 220, ml: 0, desc: 'ä¸²æ³¢æŠ€æ³•ï¼ŒNAGOMI å¿…åƒ' },
  { category: 'Agemono', name: 'å»£å³¶ç‚¸ç‰¡è £', price: 100, restaurantPrice: 160, calories: 140, ml: 0, desc: 'çˆ†æ¼¿é®®å‘³ï¼Œå¿…æ¶' },
  { category: 'Drink', name: 'ä¸‰å¾—åˆ©é ‚ç´šç”Ÿå•¤', price: 180, restaurantPrice: 250, calories: 140, ml: 350, desc: 'ç„¡é™æš¢é£²ï¼Œç¥ç´šæ³¡æ²«' },
  { category: 'Soup', name: 'å‘³å™Œæ¹¯', price: 30, restaurantPrice: 60, calories: 40, ml: 200, desc: 'æ—¥å¼ç¶“å…¸æ¹¯å“' },
];

const parseCSVLine = (line) => { const r = []; let f = '', q = false; for (let c = 0; c < line.length; c++) { const ch = line[c]; if (ch === '"') { if (c + 1 < line.length && line[c + 1] === '"') { f += '"'; c++; } else { q = !q; } } else if (ch === ',' && !q) { r.push(f); f = ''; } else { f += ch; } } r.push(f); return r; };
const parseCSV = (csvText) => { const lines = csvText.split(/\r?\n/); const result = []; if (lines.length === 0) return result; const headers = parseCSVLine(lines[0].trim()).map(h => h.trim().toLowerCase()); const colMap = { category: headers.findIndex(h => h.includes('category') || h.includes('åˆ†é¡')), name: headers.findIndex(h => h.includes('name') || h.includes('å“å')), price: headers.findIndex(h => (h.includes('price') || h.includes('å¸‚åƒ¹')) && !h.includes('restaurant') && !h.includes('hotel') && !h.includes('å®šåƒ¹')), restaurantPrice: headers.findIndex(h => h.includes('restaurant') || h.includes('å®šåƒ¹') || h.includes('é£¯åº—') || h.includes('hotel')), calories: headers.findIndex(h => h.includes('calor') || h.includes('ç†±é‡')), ml: headers.findIndex(h => h.includes('ml') || h.includes('æ¯«å‡') || h.includes('å®¹é‡') || h.includes('volum')), desc: headers.findIndex(h => h.includes('desc') || h.includes('æè¿°')) }; if (colMap.category === -1) { colMap.category = 0; colMap.name = 1; colMap.price = 2; colMap.calories = 3; colMap.desc = 4; colMap.restaurantPrice = 5; } for (let i = 1; i < lines.length; i++) { const line = lines[i].trim(); if (!line) continue; const row = parseCSVLine(line); if (row.length > 2) { const price = Number(row[colMap.price]?.trim()); const rp = Number(row[colMap.restaurantPrice]?.trim()); const ml = colMap.ml >= 0 ? Number(row[colMap.ml]?.trim()) : 0; result.push({ category: row[colMap.category]?.trim() || '', name: row[colMap.name]?.trim() || '', price: !isNaN(price) ? price : 0, restaurantPrice: !isNaN(rp) ? rp : 0, calories: Number(row[colMap.calories]?.trim()) || 0, ml: !isNaN(ml) ? ml : 0, desc: row[colMap.desc]?.trim() || '' }); } } return result; };
const generateSystemPrompt = (menuDB) => { const menuString = menuDB.map(item => `- ${item.name}: ~${item.price > 0 ? item.price : Math.round(item.restaurantPrice/1.5)}`).join('\n'); return `Context: User is eating at NAGOMI Buffet. Goal: Identify food, count items, estimate value.\nDB:\n${menuString}\nInstructions:\n1. Identify items.\n2. ESTIMATE COUNT (e.g., 3 slices). Default 1.\n3. Return JSON: { items: [{name, price, calories, count}], comment }`; };

const ProgressBar = ({ current = 0, total = 1, colorClass, label, unit = '', icon: Icon, type = 'price' }) => {
  const safeTotal = total || 1; const safeCurrent = current || 0;
  const rawPct = safeTotal > 0 ? (safeCurrent / safeTotal) * 100 : 0; const displayPct = Math.round(rawPct); const visualW = Math.min(100, Math.max(0, rawPct)); const isOver = rawPct >= 100; const isSuperOver = rawPct >= 200;
  const getMessage = () => {
    if (type === 'price') return isSuperOver ? 'ğŸ”¥ é›™å€å›æœ¬ï¼å¤ªç¥å•¦ï¼' : isOver ? 'ğŸ‰ ç›®æ¨™é”æˆï¼è³ºåˆ°äº†' : 'ğŸ’ª ç¹¼çºŒè¡ï¼Œå›æœ¬åœ¨æœ›';
    if (type === 'calories') return isSuperOver ? 'ğŸ¤¯ èƒƒå·²ç¶“æŠ•é™äº†ï¼' : isOver ? 'ğŸ«ƒ åƒå¤ªæ’å•¦ï½' : rawPct > 70 ? 'ğŸ˜‹ å¿«é£½äº†ï¼Œç²¾é¸å†æˆ°' : 'ğŸ½ï¸ èƒƒé‚„æœ‰å¾ˆå¤šç©ºé–“';
    if (type === 'liquid') return isSuperOver ? 'ğŸš½ å»æ‰€æ˜¯ä½ å®¶' : isOver ? 'ğŸŒŠ æ°´åº«æ»¿äº†ï¼' : rawPct > 50 ? 'ğŸº å†ä¾†ä¸€æ¯ï¼' : 'ğŸ¥¤ å¤šå–é»ï¼Œè§£è†©å¿…å‚™';
    return isOver ? 'ç›®æ¨™é”æˆ' : 'ç¹¼çºŒåŠ æ²¹';
  };
  return (<div className={`p-4 rounded-xl border transition-colors duration-500 ${isSuperOver ? 'bg-red-900/20 border-red-500/30' : 'bg-stone-900/50 border-stone-800'}`}><div className="flex justify-between items-end mb-2"><div className="flex items-center gap-2 text-stone-400 text-xs font-medium uppercase tracking-wider">{Icon && <Icon size={14} className={isOver ? 'text-amber-400 animate-pulse' : ''} />}{label}</div><div className="text-right"><div className="flex items-baseline justify-end gap-1"><span className={`text-lg font-black transition-colors ${isOver ? 'text-amber-400' : 'text-stone-200'}`}>{safeCurrent.toLocaleString()}</span><span className="text-xs text-stone-500"> / {safeTotal.toLocaleString()}{unit}</span></div></div></div><div className="h-2.5 w-full bg-stone-800 rounded-full overflow-hidden relative"><div className={`h-full rounded-full transition-all duration-1000 ${colorClass} ${isOver ? 'shadow-[0_0_12px_currentColor] brightness-110' : ''}`} style={{ width: `${visualW}%` }}></div>{isOver && <div className="absolute inset-0 bg-white/20 animate-pulse"></div>}</div><div className="flex justify-between items-center mt-1.5"><span className={`text-[10px] font-medium ${isSuperOver ? 'text-red-400' : isOver ? 'text-amber-500' : 'text-stone-500'}`}>{getMessage()}</span><div className={`text-xs font-bold flex items-center gap-1 ${isOver ? 'text-amber-400' : 'text-stone-400'}`}>{displayPct}%{isOver && <TrendingUp size={12} />}</div></div></div>);
};

const TimeRemaining = () => {
  const [timeLeft, setTimeLeft] = useState(''); const [session, setSession] = useState(''); const [progress, setProgress] = useState(0); const [isUrgent, setIsUrgent] = useState(false);
  useEffect(() => { const updateTimer = () => { const now = new Date(); const currentTime = now.getHours() * 60 + now.getMinutes(); const lunchStart = 690, lunchEnd = 900, dinnerStart = 1050, dinnerEnd = 1290; let start = 0, end = 0, sess = 'éç”¨é¤æ™‚æ®µ'; if (currentTime >= lunchStart && currentTime < lunchEnd) { start = lunchStart; end = lunchEnd; sess = 'åˆé¤æ™‚æ®µ'; } else if (currentTime >= dinnerStart && currentTime < dinnerEnd) { start = dinnerStart; end = dinnerEnd; sess = 'æ™šé¤æ™‚æ®µ'; } else { setSession('ä¼‘æ¯ä¸­'); setTimeLeft('--:--'); setProgress(0); return; } setSession(sess); const elapsed = currentTime - start; const remaining = end - currentTime; setProgress(Math.min(100, Math.max(0, (elapsed / (end - start)) * 100))); setTimeLeft(`${Math.floor(remaining / 60)}å°æ™‚ ${remaining % 60}åˆ†`); setIsUrgent(remaining <= 30); }; updateTimer(); const interval = setInterval(updateTimer, 60000); return () => clearInterval(interval); }, []);
  let progressColor = 'bg-emerald-500'; if (progress > 50) progressColor = 'bg-yellow-500'; if (progress > 85) progressColor = 'bg-red-500 animate-pulse';
  return (<div className={`p-4 rounded-xl border flex flex-col justify-between shadow-lg transition-colors ${isUrgent ? 'bg-red-950/30 border-red-500/50' : 'bg-gradient-to-br from-stone-800 to-stone-900 border-stone-700'}`}><div className="flex justify-between items-center mb-3"><div><div className={`text-xs font-bold uppercase tracking-wider mb-1 ${isUrgent ? 'text-red-400' : 'text-stone-400'}`}>{session} å€’æ•¸</div><div className={`text-3xl font-black font-mono tracking-tight ${isUrgent ? 'text-red-400' : 'text-stone-200'}`}>{timeLeft}</div></div><div className={`p-2 rounded-full ${isUrgent ? 'bg-red-500/20 text-red-400 animate-bounce' : 'bg-stone-800 text-stone-500'}`}>{isUrgent ? <Timer size={24} /> : <Clock size={24} />}</div></div><div className="w-full"><div className="flex justify-between text-[10px] text-stone-500 mb-1"><span>å·²ç”¨ {Math.round(progress)}%</span><span>å‰©é¤˜æ™‚é–“</span></div><div className="h-1.5 w-full bg-stone-950 rounded-full overflow-hidden"><div className={`h-full rounded-full transition-all duration-1000 ${progressColor}`} style={{ width: `${progress}%` }}></div></div></div></div>);
};

const NagomiApp = () => {
  const [activeTab, setActiveTab] = useState('dashboard'); const [history, setHistory] = useState([]); const [apiKey, setApiKey] = useState(''); const [sheetUrl, setSheetUrl] = useState(PRESET_SHEET_URL); const [menuDB, setMenuDB] = useState(DEFAULT_MENU_DB); const [priceMode, setPriceMode] = useState('market'); const [userSettings, setUserSettings] = useState(DEFAULT_SETTINGS); const [showSettings, setShowSettings] = useState(false); const [showMenuGuide, setShowMenuGuide] = useState(false); const [isUsingSheet, setIsUsingSheet] = useState(false); const [image, setImage] = useState(null); const [loading, setLoading] = useState(false); const [plateItems, setPlateItems] = useState([]); const [isEditing, setIsEditing] = useState(false); const fileInputRef = useRef(null); const cameraInputRef = useRef(null); const [activeSuggestionIndex, setActiveSuggestionIndex] = useState(null); const [suggestions, setSuggestions] = useState([]); const [guideCategory, setGuideCategory] = useState('All'); const [excludeLowCal, setExcludeLowCal] = useState(true); const [sortBy, setSortBy] = useState('cp_desc');
  const [userId, setUserId] = useState(''); const [showLogin, setShowLogin] = useState(false); const [leaderboard, setLeaderboard] = useState({ byPrice: [], byCalories: [], byDishes: [], byDrinks: [] }); const [popularDishes, setPopularDishes] = useState([]); const [leaderboardTab, setLeaderboardTab] = useState('price'); const [strategyTab, setStrategyTab] = useState('monster');
  const [showShare, setShowShare] = useState(false); const [sharePhotos, setSharePhotos] = useState([]); const [shareLayout, setShareLayout] = useState(3); const [restaurantName, setRestaurantName] = useState('NAGOMI'); const shareInputRef = useRef(null); const canvasRef = useRef(null);
  const [editingHistoryIdx, setEditingHistoryIdx] = useState(null);

  const fetchSheetData = async (url) => { if (!url) return; try { const response = await fetch(url); if (!response.ok) throw new Error('Network error'); const text = await response.text(); const parsedData = parseCSV(text); if (parsedData.length > 0) { setMenuDB(parsedData); setIsUsingSheet(true); } } catch (error) { console.error("Sheet error", error); setIsUsingSheet(false); setMenuDB(DEFAULT_MENU_DB); } };

  useEffect(() => { const storedKey = localStorage.getItem('gemini_api_key'); const storedSettings = localStorage.getItem('nagomi_user_settings'); const storedSheetUrl = localStorage.getItem('nagomi_sheet_url'); const storedPriceMode = localStorage.getItem('nagomi_price_mode'); const storedUserId = localStorage.getItem('nagomi_user_id'); if (storedKey) setApiKey(storedKey); else if (!VERCEL_API_URL) setShowSettings(true); if (storedSettings) { const parsed = JSON.parse(storedSettings); if (parsed.liquidGoal && parsed.liquidGoal < 100) parsed.liquidGoal = DEFAULT_SETTINGS.liquidGoal; setUserSettings({...DEFAULT_SETTINGS, ...parsed}); } if (storedPriceMode) setPriceMode(storedPriceMode); if (storedUserId) { setUserId(storedUserId); fetchUserData(storedUserId); } else { const storedHistory = localStorage.getItem('nagomi_history'); if (storedHistory) setHistory(JSON.parse(storedHistory)); } const targetUrl = storedSheetUrl || PRESET_SHEET_URL; setSheetUrl(targetUrl); if (targetUrl) fetchSheetData(targetUrl); fetchLeaderboard(); }, []);
  const fetchLeaderboard = async () => { try { const [usersRes, dishesRes] = await Promise.all([fetch('https://eatawarescheduler.vercel.app/api/leaderboard'), fetch('https://eatawarescheduler.vercel.app/api/leaderboard?type=dishes')]); const usersData = await usersRes.json(); const dishesData = await dishesRes.json(); if (usersData.byPrice) setLeaderboard(usersData); if (dishesData.dishes) setPopularDishes(dishesData.dishes); } catch (e) { console.error('Leaderboard fetch error:', e); } };
  const fetchUserData = async (uid) => { if (!uid) return; try { const res = await fetch(`https://eatawarescheduler.vercel.app/api/leaderboard?type=user&userId=${encodeURIComponent(uid)}`); const data = await res.json(); if (data.userData && data.userData.plates) { const allItems = data.userData.plates.flatMap(plate => plate.items || []); setHistory(allItems); localStorage.setItem('nagomi_history', JSON.stringify(allItems)); } } catch (e) { console.error('User data fetch error:', e); } };
  const submitToLeaderboard = async (items, totalPrice, totalCalories) => { if (!userId) return; try { await fetch('https://eatawarescheduler.vercel.app/api/leaderboard', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ userId, items, totalPrice, totalCalories, timestamp: Date.now() }) }); fetchLeaderboard(); } catch (e) { console.error('Submit error:', e); } };
  const syncHistoryToBackend = async (updatedHistory) => { if (!userId) return; try { await fetch('https://eatawarescheduler.vercel.app/api/leaderboard', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ userId, action: 'updateHistory', updatedHistory }) }); fetchLeaderboard(); } catch (e) { console.error('Sync error:', e); } };
  useEffect(() => { localStorage.setItem('nagomi_history', JSON.stringify(history)); }, [history]);

  const saveGlobalSettings = () => { localStorage.setItem('gemini_api_key', apiKey.trim()); localStorage.setItem('nagomi_sheet_url', sheetUrl); localStorage.setItem('nagomi_user_settings', JSON.stringify(userSettings)); if (sheetUrl) fetchSheetData(sheetUrl); setShowSettings(false); };
  const getDisplayPrice = (item) => priceMode === 'restaurant' ? (item.restaurantPrice > 0 ? item.restaurantPrice : Math.round(item.price * 1.5)) : (item.price > 0 ? item.price : Math.round(item.restaurantPrice / 1.5));
  const calculateTotal = (items) => items.reduce((acc, item) => { const dbItem = menuDB.find(db => db.name === item.name) || item; const unitPrice = getDisplayPrice(dbItem.price !== undefined ? dbItem : item); const cals = dbItem.calories || item.calories || 0; const ml = dbItem.ml || item.ml || 0; return { price: acc.price + (unitPrice * (item.count || 1)), calories: acc.calories + (cals * (item.count || 1)), liquids: acc.liquids + (ml * (item.count || 1)) }; }, { price: 0, calories: 0, liquids: 0 });

  const handleImageUpload = (e) => { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onloadend = () => { setImage(reader.result); setPlateItems([]); setIsEditing(false); setActiveTab('scan'); }; reader.readAsDataURL(file); } };
  const startManualInput = () => { setPlateItems([{ name: '', price: 0, calories: 0, count: 1, category: 'General' }]); setImage(null); setIsEditing(true); };

  const analyzeImage = async () => { if (!VERCEL_API_URL && !apiKey) { alert("è«‹å…ˆè¨­å®š API Key"); setShowSettings(true); return; } setLoading(true); try { const base64Image = image.split(',')[1]; let result; if (VERCEL_API_URL) { const response = await fetch(VERCEL_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ image: base64Image, menuDB }) }); const data = await response.json(); if (data.error) throw new Error(data.error); result = data; } else { const payload = { contents: [{ parts: [{ text: generateSystemPrompt(menuDB) }, { text: "Analyze image. Return JSON: { items: [{name, price, calories, count}], comment }" }, { inline_data: { mime_type: "image/jpeg", data: base64Image } }] }], generationConfig: { response_mime_type: "application/json" } }; const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey.trim()}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); const data = await response.json(); if (data.error) throw new Error(data.error.message); result = JSON.parse(data.candidates[0].content.parts[0].text); } const enhancedItems = result.items.map(i => { const dbMatch = menuDB.find(d => d.name.includes(i.name) || i.name.includes(d.name)); return { ...i, category: dbMatch?.category || 'General', price: dbMatch?.price || i.price, restaurantPrice: dbMatch?.restaurantPrice || 0, calories: dbMatch?.calories || i.calories, ml: dbMatch?.ml || 0, count: i.count || 1 }; }); setPlateItems(enhancedItems); setIsEditing(true); } catch (e) { alert("Error: " + e.message); } finally { setLoading(false); } };

  const confirmPlate = () => { if (plateItems.length === 0) return; const validItems = plateItems.filter(i => i.name.trim() !== ''); if (validItems.length === 0) return; const totals = calculateTotal(validItems);
    // Merge new items with existing history by name
    const newHistory = [...history];
    validItems.forEach(newItem => {
      const existingIdx = newHistory.findIndex(h => h.name === newItem.name);
      if (existingIdx >= 0) {
        newHistory[existingIdx] = { ...newHistory[existingIdx], count: (newHistory[existingIdx].count || 1) + (newItem.count || 1) };
      } else {
        newHistory.push(newItem);
      }
    });
    setHistory(newHistory); submitToLeaderboard(validItems, totals.price, totals.calories); setPlateItems([]); setImage(null); setIsEditing(false); setActiveTab('dashboard'); };
  const handleNameChange = (index, val) => { const newItems = [...plateItems]; newItems[index].name = val; setPlateItems(newItems); if (val.trim()) { setSuggestions(menuDB.filter(db => db.name.toLowerCase().includes(val.toLowerCase())).slice(0, 6)); setActiveSuggestionIndex(index); } else { setSuggestions([]); setActiveSuggestionIndex(null); } };
  const selectSuggestion = (index, dbItem) => { const newItems = [...plateItems]; newItems[index] = { ...newItems[index], name: dbItem.name, price: dbItem.price, restaurantPrice: dbItem.restaurantPrice, calories: dbItem.calories, category: dbItem.category }; setPlateItems(newItems); setActiveSuggestionIndex(null); setSuggestions([]); };
  const updateCount = (index, delta) => { setPlateItems(prev => prev.map((item, i) => i === index ? { ...item, count: Math.max(0, (item.count || 1) + delta) } : item).filter(item => item.count > 0)); };

  const processGuideItems = (items) => { let processed = items.map(item => ({ ...item, displayPrice: getDisplayPrice(item), cp: item.calories > 0 ? (getDisplayPrice(item) / item.calories).toFixed(2) : 0 })); if (excludeLowCal && activeTab === 'ranking') processed = processed.filter(item => item.calories > 5); if (activeTab === 'ranking') processed = processed.filter(item => item.displayPrice > 0); return processed.sort((a, b) => sortBy === 'cp_desc' ? b.cp - a.cp : sortBy === 'price_desc' ? b.displayPrice - a.displayPrice : a.calories - b.calories); };
  const uniqueCategories = ['All', ...new Set(menuDB.map(item => item.category))];

  const handleSharePhotos = (e) => { const files = Array.from(e.target.files); const maxPhotos = shareLayout; files.slice(0, maxPhotos - sharePhotos.length).forEach(file => { const reader = new FileReader(); reader.onloadend = () => { setSharePhotos(prev => [...prev, reader.result].slice(0, maxPhotos)); }; reader.readAsDataURL(file); }); };
  const removeSharePhoto = (idx) => setSharePhotos(prev => prev.filter((_, i) => i !== idx));
  const generateShareImage = async () => {
    const canvas = canvasRef.current; const ctx = canvas.getContext('2d');
    const W = 1080, H = 1350; canvas.width = W; canvas.height = H;
    ctx.fillStyle = '#0c0a09'; ctx.fillRect(0, 0, W, H);
    const totalStats = calculateTotal(history);
    const budget = userSettings.mealPrice;
    const today = new Date().toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric' });
    // Header
    ctx.fillStyle = '#d97706'; ctx.fillRect(0, 0, W, 120);
    ctx.fillStyle = '#fff'; ctx.font = 'bold 48px sans-serif'; ctx.textAlign = 'center';
    ctx.fillText(`${restaurantName} æˆ°ç¸¾å ±å‘Š`, W/2, 75);
    ctx.fillStyle = '#fef3c7'; ctx.font = '24px sans-serif'; ctx.fillText(today, W/2, 105);
    // Photos grid
    const padding = 30, gridTop = 150, gridH = 700;
    const photos = sharePhotos.slice(0, shareLayout);
    const loadImg = (src) => new Promise((res) => { const img = new window.Image(); img.crossOrigin = 'anonymous'; img.onload = () => res(img); img.onerror = () => res(null); img.src = src; });
    const imgs = await Promise.all(photos.map(loadImg));
    const drawImg = (img, x, y, w, h) => { if (!img) { ctx.fillStyle = '#292524'; ctx.fillRect(x, y, w, h); return; } const scale = Math.max(w/img.width, h/img.height); const sw = w/scale, sh = h/scale, sx = (img.width-sw)/2, sy = (img.height-sh)/2; ctx.drawImage(img, sx, sy, sw, sh, x, y, w, h); };
    const gap = 10;
    if (shareLayout === 3) { const iw = (W - padding*2 - gap*2) / 3; imgs.forEach((img, i) => drawImg(img, padding + i*(iw+gap), gridTop, iw, gridH)); }
    else if (shareLayout === 5) { const tw = (W - padding*2 - gap) / 2, bw = (W - padding*2 - gap*2) / 3, th = (gridH - gap) / 2; drawImg(imgs[0], padding, gridTop, tw, th); drawImg(imgs[1], padding + tw + gap, gridTop, tw, th); for (let i = 0; i < 3; i++) drawImg(imgs[2+i], padding + i*(bw+gap), gridTop + th + gap, bw, th); }
    else { const iw = (W - padding*2 - gap*2) / 3, ih = (gridH - gap*2) / 3; for (let r = 0; r < 3; r++) for (let c = 0; c < 3; c++) drawImg(imgs[r*3+c], padding + c*(iw+gap), gridTop + r*(ih+gap), iw, ih); }
    // Stats section
    const statsTop = gridTop + gridH + 40;
    ctx.fillStyle = '#1c1917'; ctx.beginPath(); ctx.roundRect(padding, statsTop, W - padding*2, 200, 20); ctx.fill();
    ctx.fillStyle = '#fbbf24'; ctx.font = 'bold 64px sans-serif'; ctx.textAlign = 'center';
    ctx.fillText(`$${totalStats.price.toLocaleString()}`, W/2, statsTop + 70);
    ctx.fillStyle = '#a8a29e'; ctx.font = '28px sans-serif';
    ctx.fillText(`${history.reduce((a,b)=>a+(b.count||1),0)} é“ Â· ${totalStats.calories.toLocaleString()} kcal Â· ${totalStats.liquids} æ¯`, W/2, statsTop + 115);
    const roi = budget > 0 ? Math.round((totalStats.price / budget) * 100) : 0;
    ctx.fillStyle = roi >= 100 ? '#22c55e' : '#ef4444'; ctx.font = 'bold 36px sans-serif';
    ctx.fillText(`å›æœ¬ç‡ ${roi}%`, W/2, statsTop + 170);
    // Footer
    ctx.fillStyle = '#57534e'; ctx.font = '20px sans-serif';
    ctx.fillText('EAS (Eat Aware Scheduler)', W/2, H - 30);
    // Download
    const link = document.createElement('a'); link.download = `${restaurantName}_${today.replace(/\s/g,'')}.png`; link.href = canvas.toDataURL('image/png'); link.click();
  };

  const renderDashboard = () => { const totalStats = calculateTotal(history); const budget = userSettings.mealPrice; return (<div className="space-y-4 animate-fade-in pb-24"><TimeRemaining /><div className="grid grid-cols-2 gap-3"><div className="bg-stone-900 border border-stone-800 p-4 rounded-xl"><div className="text-xs text-stone-500 mb-1">ç›®å‰ç´¯è¨ˆåƒ¹å€¼ ({priceMode === 'restaurant' ? 'é¤å»³åƒ¹' : 'é£Ÿæåƒ¹'})</div><div className="text-3xl font-black text-amber-400">${totalStats.price.toLocaleString()}</div></div><div className="bg-stone-900 border border-stone-800 p-4 rounded-xl"><div className="text-xs text-stone-500 mb-1">å·²åƒé …ç›®æ•¸</div><div className="text-3xl font-black text-stone-200">{history.reduce((a,b)=>a+(b.count||1),0)} <span className="text-sm text-stone-500">é“</span></div></div></div><h3 className="text-stone-400 text-xs font-bold uppercase tracking-widest mt-4 px-1">æˆ°æ³åˆ†æ</h3><ProgressBar current={totalStats.price} total={budget} label="å›æœ¬é€²åº¦" unit="å…ƒ" colorClass="bg-gradient-to-r from-amber-600 to-yellow-500" icon={DollarSign} type="price"/><ProgressBar current={totalStats.calories} total={userSettings.calorieGoal} label="ç†±é‡é¡åº¦" unit=" kcal" colorClass="bg-gradient-to-r from-green-600 to-emerald-400" icon={Zap} type="calories"/><ProgressBar current={totalStats.liquids} total={userSettings.liquidGoal} label="æ¶²é«”æ”å–" unit=" ml" colorClass="bg-gradient-to-r from-blue-600 to-cyan-400" icon={Droplets} type="liquid"/><div className="mt-6 p-4 bg-stone-900 rounded-xl border border-stone-800"><h4 className="text-stone-300 font-bold mb-2 text-sm">ç›®å‰æ”»ç•¥å»ºè­°</h4><p className="text-xs text-stone-500 leading-relaxed">{totalStats.price < budget ? "åŠ æ²¹ï¼é‚„æ²’å›æœ¬ï¼Œå»ºè­°å¤šæ‹¿äº›ã€Œç‚™ç‡’å¹²è²ã€æˆ–ã€Œé¦™é­šã€ã€‚" : "å¤ªå¼·äº†ï¼å·²ç¶“å›æœ¬ï¼Œç¾åœ¨é–‹å§‹æ˜¯è³ºåˆ°çš„ï¼Œå¯ä»¥äº«å—ä¸€äº›ç²¾ç·»ç”œé»å›‰ï¼"}{totalStats.calories > userSettings.calorieGoal * 0.8 && " ç†±é‡å¿«è¶…æ¨™äº†ï¼Œå»ºè­°é¿é–‹æ¾±ç²‰é¡ã€‚"}</p></div>{history.length > 0 && (<button onClick={() => { setSharePhotos([]); setShowShare(true); }} className="w-full mt-4 py-4 rounded-xl bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold flex items-center justify-center gap-2 shadow-lg"><Share size={20} /> åˆ†äº«ä»Šæ—¥æˆ°ç¸¾</button>)}</div>); };

  const deleteHistoryItem = (idx) => { if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ')) return; const newHistory = history.filter((_, i) => i !== idx); setHistory(newHistory); syncHistoryToBackend(newHistory); };
  const updateHistoryItem = (idx, field, value) => { const newHistory = [...history]; newHistory[idx] = { ...newHistory[idx], [field]: value }; setHistory(newHistory); };
  const saveHistoryEdit = () => { setEditingHistoryIdx(null); syncHistoryToBackend(history); };
  const renderHistory = () => (<div className="animate-fade-in pb-24"><h3 className="text-xl font-bold text-stone-200 mb-4 px-2">ä»Šæ—¥æˆ°ç¸¾</h3>{history.length === 0 ? (<div className="text-center text-stone-500 py-20">é‚„æ²’æœ‰ç´€éŒ„ï¼Œå¿«å»é–‹åƒï¼</div>) : (<div className="bg-stone-900 rounded-2xl border border-stone-800 overflow-hidden"><div className="divide-y divide-stone-800">{history.map((item, idx) => (<div key={idx} className="p-4">{editingHistoryIdx === idx ? (<div className="space-y-3"><input className="w-full bg-stone-800 border border-stone-700 rounded p-2 text-stone-200 text-sm" value={item.name} onChange={e => updateHistoryItem(idx, 'name', e.target.value)} placeholder="å“å" /><div className="grid grid-cols-2 gap-2"><div><label className="text-stone-500 text-[10px]">æ•¸é‡</label><input type="number" className="w-full bg-stone-800 border border-stone-700 rounded p-2 text-stone-200 text-sm" value={item.count || 1} onChange={e => updateHistoryItem(idx, 'count', Number(e.target.value) || 1)} /></div><div><label className="text-stone-500 text-[10px]">ç†±é‡</label><input type="number" className="w-full bg-stone-800 border border-stone-700 rounded p-2 text-stone-200 text-sm" value={item.calories || 0} onChange={e => updateHistoryItem(idx, 'calories', Number(e.target.value) || 0)} /></div><div><label className="text-stone-500 text-[10px]">é£Ÿæåƒ¹</label><input type="number" className="w-full bg-stone-800 border border-stone-700 rounded p-2 text-amber-400 text-sm" value={item.price || 0} onChange={e => updateHistoryItem(idx, 'price', Number(e.target.value) || 0)} /></div><div><label className="text-stone-500 text-[10px]">é¤å»³åƒ¹</label><input type="number" className="w-full bg-stone-800 border border-stone-700 rounded p-2 text-amber-400 text-sm" value={item.restaurantPrice || 0} onChange={e => updateHistoryItem(idx, 'restaurantPrice', Number(e.target.value) || 0)} /></div></div><div className="flex gap-2"><button onClick={() => setEditingHistoryIdx(null)} className="flex-1 py-2 rounded-lg border border-stone-700 text-stone-400 text-xs">å–æ¶ˆ</button><button onClick={saveHistoryEdit} className="flex-1 py-2 rounded-lg bg-green-600 text-white text-xs font-bold">å„²å­˜</button></div></div>) : (<div className="flex justify-between items-center"><div className="flex-1" onClick={() => setEditingHistoryIdx(idx)}><div className="text-stone-200 font-bold text-sm">{item.name}</div><div className="text-stone-500 text-xs flex gap-2"><span>x{item.count}</span><span>{(item.calories || 0) * (item.count || 1)} kcal</span></div></div><div className="flex items-center gap-3"><div className="text-amber-400 font-mono font-bold">${getDisplayPrice(item) * (item.count || 1)}</div><button onClick={() => deleteHistoryItem(idx)} className="p-2 text-stone-600 hover:text-red-500"><X size={16} /></button></div></div>)}</div>))}<div className="p-4 bg-stone-950 flex justify-between items-center text-stone-400 text-sm font-bold"><span>ç¸½è¨ˆ ({priceMode === 'restaurant' ? 'é¤å»³åƒ¹' : 'é£Ÿæåƒ¹'})</span><span>${calculateTotal(history).price}</span></div></div><button onClick={() => {if(confirm("ç¢ºå®šè¦æ¸…ç©ºç´€éŒ„å—ï¼Ÿ")) { setHistory([]); syncHistoryToBackend([]); }}} className="w-full p-4 text-xs text-red-500 hover:bg-stone-800 border-t border-stone-800">æ¸…ç©ºæ­·å²ç´€éŒ„</button></div>)}</div>);
  const renderLeaderboard = () => { const priceList = priceMode === 'restaurant' ? (leaderboard.byPriceRestaurant || leaderboard.byPrice) : leaderboard.byPrice; const currentList = leaderboardTab === 'price' ? priceList : leaderboardTab === 'calories' ? leaderboard.byCalories : leaderboardTab === 'dishes' ? leaderboard.byDishes : leaderboardTab === 'drinks' ? leaderboard.byDrinks : popularDishes; const isPopular = leaderboardTab === 'popular'; const stats = leaderboard.stats || {}; return (<div className="animate-fade-in pb-24"><div className="flex items-center justify-between mb-4 px-2"><h3 className="text-xl font-bold text-stone-200">æ’è¡Œæ¦œ</h3><button onClick={fetchLeaderboard} className="p-2 text-stone-400 hover:text-amber-400"><RefreshCw size={16} /></button></div>{(stats.grandTotal > 0 || stats.grandTotalRestaurant > 0) && (<div className="bg-gradient-to-br from-amber-900/30 to-stone-900 border border-amber-700/50 rounded-2xl p-4 mb-4 text-center"><div className="text-stone-400 text-xs mb-1">ğŸ† å…¨é«”æˆ°å£«ç¸½æˆ°ç¸¾ ({priceMode === 'restaurant' ? 'é¤å»³åƒ¹' : 'é£Ÿæåƒ¹'})</div><div className="text-3xl font-black text-amber-400">${(priceMode === 'restaurant' ? stats.grandTotalRestaurant : stats.grandTotal)?.toLocaleString() || 0}</div></div>)}{!userId && (<div className="bg-amber-900/20 border border-amber-700 rounded-xl p-4 mb-4 text-center"><p className="text-amber-400 text-sm mb-2">ç™»å…¥å¾Œæ‰èƒ½åƒèˆ‡æ’è¡Œ</p><button onClick={() => setShowLogin(true)} className="bg-amber-600 text-white px-4 py-2 rounded-lg text-sm font-bold">è¼¸å…¥ ID ç™»å…¥</button></div>)}{userId && (<div className="bg-stone-800 rounded-xl p-3 mb-4 flex items-center gap-2"><User size={16} className="text-amber-400" /><span className="text-stone-300 text-sm">ç›®å‰èº«ä»½: <span className="text-amber-400 font-bold">{userId}</span></span><button onClick={() => { setUserId(''); localStorage.removeItem('nagomi_user_id'); }} className="ml-auto text-xs text-stone-500 hover:text-red-400">ç™»å‡º</button></div>)}<div className="flex gap-1 mb-4 overflow-x-auto pb-2"><button onClick={() => setLeaderboardTab('price')} className={`px-3 py-1.5 rounded-lg text-xs font-bold whitespace-nowrap ${leaderboardTab === 'price' ? 'bg-amber-600 text-white' : 'bg-stone-800 text-stone-400'}`}>åƒæœ€å¤šéŒ¢</button><button onClick={() => setLeaderboardTab('dishes')} className={`px-3 py-1.5 rounded-lg text-xs font-bold whitespace-nowrap ${leaderboardTab === 'dishes' ? 'bg-amber-600 text-white' : 'bg-stone-800 text-stone-400'}`}>åƒæœ€å¤šé“</button><button onClick={() => setLeaderboardTab('calories')} className={`px-3 py-1.5 rounded-lg text-xs font-bold whitespace-nowrap ${leaderboardTab === 'calories' ? 'bg-amber-600 text-white' : 'bg-stone-800 text-stone-400'}`}>æœ€é«˜ç†±é‡</button><button onClick={() => setLeaderboardTab('drinks')} className={`px-3 py-1.5 rounded-lg text-xs font-bold whitespace-nowrap ${leaderboardTab === 'drinks' ? 'bg-amber-600 text-white' : 'bg-stone-800 text-stone-400'}`}>å–æœ€å¤š</button><button onClick={() => setLeaderboardTab('popular')} className={`px-3 py-1.5 rounded-lg text-xs font-bold whitespace-nowrap ${leaderboardTab === 'popular' ? 'bg-green-600 text-white' : 'bg-stone-800 text-stone-400'}`}>ç†±é–€èœè‰²</button></div><div className="bg-stone-900 rounded-2xl border border-stone-800 overflow-hidden">{currentList.length === 0 ? (<div className="p-8 text-center text-stone-500">é‚„æ²’æœ‰è³‡æ–™</div>) : (<div className="divide-y divide-stone-800">{currentList.map((item, idx) => (<div key={idx} className={`p-4 flex items-center gap-3 ${item.id === userId ? 'bg-amber-900/20' : ''}`}><div className={`w-8 h-8 flex items-center justify-center rounded-full font-bold text-sm ${idx === 0 ? 'bg-yellow-500 text-yellow-900' : idx === 1 ? 'bg-gray-300 text-gray-700' : idx === 2 ? 'bg-amber-700 text-amber-100' : 'bg-stone-800 text-stone-500'}`}>{idx + 1}</div><div className="flex-1"><div className="text-stone-200 font-bold text-sm">{isPopular ? item.name : item.id}</div>{isPopular ? (<div className="text-stone-500 text-xs">${(() => { const dbMatch = menuDB.find(m => m.name === item.name || m.name.includes(item.name) || item.name.includes(m.name)); return priceMode === 'restaurant' ? (item.restaurantPrice || dbMatch?.restaurantPrice || item.price || 0) : (item.price || dbMatch?.price || 0); })()}</div>) : (<div className="text-xs flex flex-wrap gap-x-2"><span className={leaderboardTab === 'dishes' ? 'text-amber-400 font-bold' : 'text-stone-500'}>{item.totalDishes} é“</span><span className={leaderboardTab === 'calories' ? 'text-amber-400 font-bold' : 'text-stone-500'}>{item.totalCalories} kcal</span><span className={leaderboardTab === 'drinks' ? 'text-amber-400 font-bold' : 'text-stone-500'}>{item.totalLiquid || item.totalDrinks || 0} ml</span></div>)}</div><div className="text-right"><div className={`font-mono font-bold ${isPopular || leaderboardTab === 'price' ? 'text-amber-400 text-lg' : 'text-stone-400'}`}>{isPopular ? `${item.count} ä»½` : `$${priceMode === 'restaurant' ? (item.totalPriceRestaurant || item.totalPrice) : item.totalPrice}`}</div></div></div>))}</div>)}</div></div>); };
  const STRATEGIES = {
    monster: { name: 'ç”Ÿé£Ÿå›æœ¬æ€ªç¸', emoji: 'ğŸ†', desc: 'é£Ÿé‡å¤§ï¼Œè¶…æ„›ç”Ÿé­šç‰‡ï¼Œè¿½æ±‚æ¥µè‡´ CP å€¼', target: 'åƒå®é¤å»³ï¼Œå°ˆæ”»é«˜å–®åƒ¹é£Ÿæ', limit: '2500 kcal / æ¶²é«”å°‘é‡', result: { value: 3815, calories: 2130, roi: 251 }, items: [
      { cat: 'ç”Ÿé­šç‰‡', name: 'æ—¥æœ¬é°¤é­šã€ç´…é­½ã€é®­é­š', qty: 'å„5ç‰‡', value: 900, cal: 625, tip: 'å°ˆæ”»é«˜å–®åƒ¹é­šç¨®' },
      { cat: 'ç”Ÿé­šç‰‡', name: 'èƒ­è„‚è¦ã€ç”œè¦', qty: 'å„5éš»', value: 575, cal: 150, tip: 'èƒ­è„‚è¦æ˜¯å›æœ¬æ ¸å¿ƒ' },
      { cat: 'å£½å¸', name: 'é®­é­šåµæ‰‹å·ã€å¹²è²æ¡å£½å¸', qty: 'å„2ä»½', value: 420, cal: 230, tip: 'åªåƒé€™å…©æ¨£' },
      { cat: 'ç‚¸ç‰©', name: 'ç‚¸è»Ÿæ®¼èŸ¹ã€å»£å³¶ç‚¸ç‰¡è £', qty: 'å„2ä»½', value: 520, cal: 420, tip: 'è»Ÿæ®¼èŸ¹å¸‚åƒ¹æ¥µé«˜' },
      { cat: 'ç†Ÿé£Ÿ', name: 'ä½æº«æ…¢çƒ¤ç‰›è‚‰', qty: '2ä»½', value: 700, cal: 300, tip: 'è¥¿é¤å»³åƒé€™å…©ç›¤å°±è¦700' },
      { cat: 'è’¸ç‰©', name: 'æµ·è†½è’¸è›‹ã€é®‘é­šåœŸä½å‡', qty: 'å„1ä»½', value: 270, cal: 105, tip: 'ç²¾ç·»é«˜åƒ¹å°ç¼½' },
      { cat: 'é£²æ–™', name: 'å†·æ³¡ç„™èŒ¶', qty: '2æ¯', value: 200, cal: 0, tip: 'å»æ²¹è§£è†©ä¸ä½”èƒƒ' },
      { cat: 'ç”œé»', name: 'å¨å£«å¿Œå†°æ·‡æ·‹ã€æœ€ä¸­é¤…', qty: 'å„1ä»½', value: 230, cal: 300, tip: 'å®Œç¾æ”¶å°¾' }
    ]},
    izakaya: { name: 'å±…é…’å±‹æš¢é£²æµ', emoji: 'ğŸº', desc: 'é£Ÿé‡æ™®é€šï¼Œä½†é…’é‡å¥½ï¼Œå¯ä»¥å–4æ¯', target: 'æŠŠé€™è£¡ç•¶æˆé«˜ç´šå±…é…’å±‹', limit: 'ç†±é‡ä¸æ‹˜ / æ¶²é«”1000ml+', result: { value: 1955, calories: 1200, roi: 128 }, items: [
      { cat: 'é…’æ°´', name: 'ä¸‰å¾—åˆ©é ‚ç´šç”Ÿå•¤', qty: '2æ¯', value: 320, cal: 280, tip: 'ç¥ç´šæ³¡æ²«ï¼Œå±…é…’å±‹ä¸€æ¯$160èµ·' },
      { cat: 'é…’æ°´', name: 'é‡‘è³“/æ¸…é…’ Highball', qty: '2æ¯', value: 270, cal: 200, tip: 'æ°£æ³¡æ„Ÿè§£è†©ï¼Œé…çƒ¤ç‰©ç„¡æ•µ' },
      { cat: 'çƒ¤ç‰©', name: 'é¦™é­šå§¿ç‡’', qty: '1å°¾', value: 150, cal: 120, tip: 'ç‚ºäº†é€™éš»é­šä¾†çš„' },
      { cat: 'çƒ¤ç‰©', name: 'æ‰‹ä½œé›è‚‰ä¸²ã€çƒ¤å°å·', qty: 'å„2ä¸²', value: 300, cal: 180, tip: 'å…¸å‹çš„ä¸‹é…’èœ' },
      { cat: 'ç‚¸ç‰©', name: 'ç‚¸è¦å¤©å©¦ç¾…ã€ç‚¸ç‰¡è £', qty: 'å„2éš»', value: 300, cal: 250, tip: 'ç‚¸ç‰©é…å•¤é…’æ˜¯çœŸç†' },
      { cat: 'ç†Ÿé£Ÿ', name: 'è’œç‰‡éª°å­ç‰›ã€æœ´è‘‰å‘³å™Œç‰›', qty: 'å„1ä»½', value: 240, cal: 200, tip: 'é‡å£å‘³è‚‰é¡é…é…’' },
      { cat: 'å°ç¼½', name: 'è¢çƒè³Š/æµ·èº/èµ·å¸ç«è…¿', qty: 'å„1ä»½', value: 275, cal: 150, tip: 'å†·ç›¤ä¸‹é…’å°èœ' },
      { cat: 'æ¹¯å“', name: 'ç¾ç…®è›¤è £æ¹¯', qty: '1ç¢—', value: 100, cal: 50, tip: 'æœ€å¾Œå–ä¸€ç¢—é†’é…’' }
    ]},
    carnivore: { name: 'è‚‰é£Ÿç”œé»æ§', emoji: 'ğŸ¥©', desc: 'ä¸åƒç”Ÿé£Ÿ/æµ·é®®ï¼Œä¹Ÿä¸å–é…’', target: 'é ç‰›è‚‰ã€ç†Ÿé£Ÿå’Œç”œé»æ‰³å›ä¸€åŸ', limit: '2000 kcal / å–œæ­¡ç²¾ç·»ç”œé»', result: { value: 3740, calories: 3400, roi: 246 }, items: [
      { cat: 'ç†Ÿé£Ÿ', name: 'ä½æº«æ…¢çƒ¤ç‰›è‚‰', qty: '4ä»½', value: 1400, cal: 600, tip: 'é€™æ˜¯ä½ çš„ä¸»åŠ›ï¼Œç‹‚åƒç‰›è‚‰' },
      { cat: 'éµæ¿', name: 'éµæ¿éª°å­ç‰›ã€æ¿è…±ç‰›', qty: 'å„2ä»½', value: 480, cal: 500, tip: 'ä¸åŒéƒ¨ä½è¼ªæµåƒ' },
      { cat: 'ç‚¸ç‰©', name: 'ç‚¸è»Ÿæ®¼èŸ¹', qty: '2ä»½', value: 360, cal: 280, tip: 'ä¸åƒæµ·é®®çš„äººä¹Ÿèƒ½æ¥å—' },
      { cat: 'ç†Ÿé£Ÿ', name: 'å’Œç‰›å£½å–œç‡’', qty: '1ç¢—', value: 200, cal: 220, tip: 'äº«å—å’Œç‰›æ²¹è„‚' },
      { cat: 'é£²æ–™', name: 'è¥¿è¥¿é‡Œæª¸æª¬å’–å•¡', qty: '2æ¯', value: 280, cal: 180, tip: 'ç”¨å’–å•¡è§£è‚‰é¡çš„è†©' },
      { cat: 'ç”œé»', name: 'å¯éº—éœ² CanelÃ©', qty: '3é¡†', value: 210, cal: 360, tip: 'ç”œé»æ«ƒæœ€è²´çš„' },
      { cat: 'ç”œé»', name: 'é¦¬æ–¯å¡å½­ç„¡èŠ±æœã€ç”Ÿå·§å¡”', qty: 'å„2ä»½', value: 350, cal: 600, tip: 'å°ˆæ”»ç²¾ç·»è¥¿é»' },
      { cat: 'å†°å“', name: 'å¨å£«å¿Œé¦™è‰ã€éº¥èŒ¶å†°æ·‡æ·‹', qty: 'å„2çƒ', value: 460, cal: 660, tip: 'è‡ªå®¶è£½å†°æ·‡æ·‹å›æœ¬é‡é»' }
    ]},
    analyst: { name: 'ç²¾ç®—å¸«', emoji: 'âš–ï¸', desc: '2000 kcal + 1å…¬å‡é£²æ–™çš„å®Œç¾å¹³è¡¡', target: 'åœ¨é™åˆ¶å…§é”æˆç‡Ÿé¤Šèˆ‡åƒ¹å€¼å¹³è¡¡', limit: '2000 kcal / 900ml æ¶²é«”', result: { value: 2440, calories: 1690, roi: 160 }, items: [
      { cat: 'é–‹èƒƒ', name: 'åœŸç“¶è’¸', qty: '1å£º', value: 120, cal: 35, tip: 'æš–èƒƒï¼Œä½å¡é«˜åƒ¹å€¼' },
      { cat: 'å†·ç›¤', name: 'ç¶œåˆç”Ÿé­šç‰‡(å«èƒ­è„‚è¦)', qty: '8ç‰‡', value: 600, cal: 350, tip: 'å„ªè³ªè›‹ç™½è³ªï¼Œç†±é‡ä½' },
      { cat: 'é£²æ–™', name: 'ç™½è‘¡è„é…’', qty: '1æ¯', value: 220, cal: 90, tip: 'é…æµ·é®®ï¼Œåƒ¹å€¼é«˜ï¼Œé‡å°‘' },
      { cat: 'ç†Ÿé£Ÿ', name: 'çƒ¤é¦™é­š + è»Ÿæ®¼èŸ¹', qty: 'å„1', value: 330, cal: 280, tip: 'NAGOMI å¿…åƒæ‹›ç‰Œ' },
      { cat: 'ä¸»é¤', name: 'ä½æº«æ…¢çƒ¤ç‰›è‚‰', qty: '1ä»½', value: 350, cal: 150, tip: 'æ§åˆ¶ç†±é‡çš„ä¸»é£Ÿ' },
      { cat: 'é£²æ–™', name: 'é‡‘è³“ Highball', qty: '1æ¯', value: 120, cal: 100, tip: 'ä¸­å ´è§£è†©ï¼Œæ°£æ³¡æ„Ÿ' },
      { cat: 'å£½å¸', name: 'é®­é­šåµ/å¹²è²æ‰‹å·(å°‘é£¯)', qty: '2æ²', value: 240, cal: 140, tip: 'é«˜å–®åƒ¹å£½å¸ï¼Œå°‘é£¯çœç†±é‡' },
      { cat: 'ç”œé»', name: 'å¯éº—éœ² + æœ€ä¸­é¤…', qty: 'å„1', value: 170, cal: 240, tip: 'ç²¾ç·»ç”œé»æ”¶å°¾' },
      { cat: 'å†°å“', name: 'ç¾©å¼å†°æ·‡æ·‹(èŒ¶å£å‘³)', qty: '2çƒ', value: 200, cal: 300, tip: 'å®Œç¾çš„å¥é»' },
      { cat: 'é£²æ–™', name: 'ç¾å¼å’–å•¡', qty: '1æ¯', value: 90, cal: 5, tip: 'æ­é…ç”œé»ï¼Œè£œè¶³æ¶²é«”' }
    ]}
  };
  const renderStrategy = () => { const s = STRATEGIES[strategyTab]; return (<div className="animate-fade-in pb-24"><h3 className="text-xl font-bold text-stone-200 mb-4 px-2">ç­–ç•¥åƒè€ƒ</h3><div className="flex gap-1 mb-4 overflow-x-auto pb-2">{Object.entries(STRATEGIES).map(([key, val]) => (<button key={key} onClick={() => setStrategyTab(key)} className={`px-3 py-1.5 rounded-lg text-xs font-bold whitespace-nowrap ${strategyTab === key ? 'bg-amber-600 text-white' : 'bg-stone-800 text-stone-400'}`}>{val.emoji} {val.name}</button>))}</div><div className="bg-stone-900 rounded-2xl border border-stone-800 p-4 mb-4"><div className="flex items-center gap-2 mb-2"><span className="text-2xl">{s.emoji}</span><h4 className="text-lg font-bold text-amber-400">{s.name}</h4></div><p className="text-stone-400 text-sm mb-2">{s.desc}</p><div className="grid grid-cols-2 gap-2 text-xs"><div className="bg-stone-800 rounded-lg p-2"><div className="text-stone-500">ç›®æ¨™</div><div className="text-stone-200">{s.target}</div></div><div className="bg-stone-800 rounded-lg p-2"><div className="text-stone-500">é™åˆ¶</div><div className="text-stone-200">{s.limit}</div></div></div></div><div className="bg-gradient-to-r from-amber-900/30 to-yellow-900/30 border border-amber-700/50 rounded-xl p-4 mb-4"><div className="flex justify-between items-center"><div><div className="text-amber-400 text-xs">é ä¼°åƒ¹å€¼</div><div className="text-2xl font-black text-amber-400">${s.result.value.toLocaleString()}</div></div><div className="text-right"><div className="text-stone-400 text-xs">ç†±é‡ {s.result.calories} kcal</div><div className="text-green-400 font-bold">å›æœ¬ç‡ {s.result.roi}%</div></div></div></div><div className="space-y-2">{s.items.map((item, idx) => (<div key={idx} className="bg-stone-900 border border-stone-800 rounded-xl p-3"><div className="flex justify-between items-start"><div className="flex-1"><div className="flex items-center gap-2"><span className="text-[10px] bg-stone-700 text-stone-300 px-1.5 py-0.5 rounded">{item.cat}</span><span className="text-stone-200 font-bold text-sm">{item.name}</span></div><div className="text-stone-500 text-xs mt-1">{item.tip}</div></div><div className="text-right shrink-0 ml-2"><div className="text-stone-400 text-xs">{item.qty}</div><div className="text-amber-400 font-mono font-bold">${item.value}</div><div className="text-stone-600 text-[10px]">{item.cal} kcal</div></div></div></div>))}</div></div>); };

  return (
    <div className="min-h-screen bg-stone-950 text-stone-100 font-sans selection:bg-amber-900">
      <div className="bg-stone-950 p-4 border-b border-stone-800 flex justify-between items-center sticky top-0 z-30">
        <div className="flex items-center gap-2"><div className="bg-amber-600 p-2 rounded-lg"><Coins size={20} className="text-white" /></div><h1 className="font-bold text-lg tracking-wide text-amber-50">EAS (Eat Aware Scheduler)</h1></div>
        <div className="flex gap-2 items-center">
          <button onClick={() => { const newMode = priceMode === 'market' ? 'restaurant' : 'market'; setPriceMode(newMode); localStorage.setItem('nagomi_price_mode', newMode); }} className={`flex items-center gap-1 px-3 py-1.5 rounded-lg text-[10px] font-bold border transition-all ${priceMode === 'restaurant' ? 'bg-amber-900/30 border-amber-600 text-amber-500' : 'bg-stone-800 border-stone-700 text-stone-400'}`}>{priceMode === 'restaurant' ? <Utensils size={12} /> : <DollarSign size={12} />}{priceMode === 'restaurant' ? 'é¤å»³åƒ¹' : 'é£Ÿæåƒ¹'}</button>
          <button onClick={() => { setShowMenuGuide(true); setActiveTab('category'); }} className="p-2 text-stone-400 hover:text-amber-400"><BookOpen size={20} /></button>
          <button onClick={() => setShowSettings(true)} className="p-2 text-stone-400 hover:text-amber-400"><Settings size={20} /></button>
        </div>
      </div>

      {showSettings && (<div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4"><div className="bg-stone-900 border border-stone-700 p-6 rounded-2xl w-full max-w-sm space-y-4"><div className="flex justify-between items-center"><h3 className="font-bold text-amber-50">è¨­å®š</h3><button onClick={() => setShowSettings(false)}><X size={20} className="text-stone-500"/></button></div><div className="space-y-3 text-sm">{userId && (<div className="p-3 bg-stone-800 border border-stone-700 rounded-lg flex items-center justify-between"><div className="flex items-center gap-2"><User size={16} className="text-amber-400" /><span className="text-stone-300">ID: <span className="text-amber-400 font-bold">{userId}</span></span></div><button onClick={() => { setUserId(''); localStorage.removeItem('nagomi_user_id'); setHistory([]); }} className="text-xs text-red-400 hover:text-red-300">ç™»å‡º</button></div>)}{!VERCEL_API_URL && (<div><label className="text-stone-400 block mb-1">API Key</label><input type="password" className="w-full bg-stone-950 border border-stone-800 rounded p-2" value={apiKey} onChange={e=>setApiKey(e.target.value)}/></div>)}<div className="p-2 bg-stone-800 border border-stone-700 rounded text-xs text-stone-400">ğŸ“· éš±ç§èªªæ˜ï¼šæˆ‘å€‘ä¸æœƒå„²å­˜ä½ çš„ç…§ç‰‡ã€‚ä½†æœ¬æœå‹™ä½¿ç”¨å…è²» Gemini APIï¼Œä¾ Google æ¢æ¬¾ï¼Œåœ–ç‰‡å¯èƒ½è¢«ç”¨æ–¼æ”¹å–„å…¶ AI æ¨¡å‹ã€‚</div><div><label className="text-stone-400 block mb-1">é¤è²»åƒ¹æ ¼ï¼ˆå«10%æœå‹™è²»ï¼‰</label><input type="number" className="w-full bg-stone-950 border border-stone-800 rounded p-2" value={userSettings.mealPrice} onChange={e=>setUserSettings({...userSettings, mealPrice: Number(e.target.value)})}/></div><div><label className="text-stone-400 block mb-1">ç›®æ¨™ç†±é‡ (kcal)</label><input type="number" className="w-full bg-stone-950 border border-stone-800 rounded p-2" value={userSettings.calorieGoal} onChange={e=>setUserSettings({...userSettings, calorieGoal: Number(e.target.value)})}/></div><div><label className="text-stone-400 block mb-1">æ¶²é«”ç›®æ¨™ (ml)</label><input type="number" className="w-full bg-stone-950 border border-stone-800 rounded p-2" value={userSettings.liquidGoal} onChange={e=>setUserSettings({...userSettings, liquidGoal: Number(e.target.value)})}/></div></div><button onClick={saveGlobalSettings} className="w-full bg-amber-600 text-white py-3 rounded-xl font-bold">å„²å­˜è¨­å®š</button></div></div>)}
      {showLogin && (<div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4"><div className="bg-stone-900 border border-stone-700 p-6 rounded-2xl w-full max-w-sm space-y-4"><div className="flex justify-between items-center"><h3 className="font-bold text-amber-50">ç™»å…¥æ’è¡Œæ¦œ</h3><button onClick={() => setShowLogin(false)}><X size={20} className="text-stone-500"/></button></div><div className="space-y-3 text-sm"><p className="text-stone-400 text-xs">è¼¸å…¥ä½ çš„ ID å³å¯åƒèˆ‡æ’è¡Œï¼ˆä¸éœ€å¯†ç¢¼ï¼‰</p><div><label className="text-stone-400 block mb-1">ä½ çš„ ID</label><input type="text" className="w-full bg-stone-950 border border-stone-800 rounded p-2 text-lg" placeholder="ä¾‹: å°æ˜ã€Amy..." value={userId} onChange={e => setUserId(e.target.value)} /></div></div><button onClick={() => { if (userId.trim()) { localStorage.setItem('nagomi_user_id', userId.trim()); fetchUserData(userId.trim()); setShowLogin(false); } }} className="w-full bg-amber-600 text-white py-3 rounded-xl font-bold">ç¢ºèªç™»å…¥</button></div></div>)}

      {showShare && (<div className="fixed inset-0 bg-black/90 backdrop-blur-sm z-50 overflow-y-auto"><div className="min-h-full p-4 pb-20"><div className="max-w-md mx-auto space-y-4">
        <div className="flex justify-between items-center"><h3 className="text-xl font-bold text-amber-50">åˆ†äº«æˆ°ç¸¾</h3><button onClick={() => setShowShare(false)}><X size={24} className="text-stone-400"/></button></div>
        <div><label className="text-stone-400 text-sm block mb-2">é¤å»³åç¨±</label><input type="text" className="w-full bg-stone-900 border border-stone-700 rounded-lg p-3 text-stone-200" value={restaurantName} onChange={e => setRestaurantName(e.target.value)} placeholder="è¼¸å…¥é¤å»³åç¨±..." /></div>
        <div><label className="text-stone-400 text-sm block mb-2">é¸æ“‡ç‰ˆå‹</label><div className="flex gap-2">{[3, 5, 9].map(n => (<button key={n} onClick={() => { setShareLayout(n); setSharePhotos(prev => prev.slice(0, n)); }} className={`flex-1 py-3 rounded-lg font-bold text-sm ${shareLayout === n ? 'bg-amber-600 text-white' : 'bg-stone-800 text-stone-400'}`}>{n} å¼µ</button>))}</div></div>
        <div><label className="text-stone-400 text-sm block mb-2">é¸æ“‡ç…§ç‰‡ ({sharePhotos.length}/{shareLayout})</label>
        <div className={`grid gap-2 ${shareLayout === 3 ? 'grid-cols-3' : shareLayout === 5 ? 'grid-cols-3' : 'grid-cols-3'}`}>
          {Array.from({ length: shareLayout }).map((_, i) => (<div key={i} className="aspect-square relative rounded-lg overflow-hidden bg-stone-800 border border-stone-700">
            {sharePhotos[i] ? (<><img src={sharePhotos[i]} className="w-full h-full object-cover" /><button onClick={() => removeSharePhoto(i)} className="absolute top-1 right-1 bg-black/60 rounded-full p-1"><X size={14} className="text-white" /></button></>) : (<button onClick={() => shareInputRef.current?.click()} className="w-full h-full flex flex-col items-center justify-center text-stone-500 hover:text-stone-300"><ImageIcon size={24} /><span className="text-[10px] mt-1">æ·»åŠ </span></button>)}
          </div>))}
        </div>
        <input type="file" accept="image/*" multiple ref={shareInputRef} className="hidden" onChange={handleSharePhotos} /></div>
        <div className="bg-stone-900 border border-stone-700 rounded-xl p-4"><div className="text-stone-400 text-xs mb-2">é è¦½è³‡è¨Š</div><div className="text-center"><div className="text-2xl font-black text-amber-400">${calculateTotal(history).price.toLocaleString()}</div><div className="text-stone-500 text-sm">{history.reduce((a,b)=>a+(b.count||1),0)} é“ Â· {calculateTotal(history).calories} kcal</div><div className="text-stone-600 text-xs mt-1">{new Date().toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric' })}</div></div></div>
        <button onClick={generateShareImage} disabled={sharePhotos.length === 0} className={`w-full py-4 rounded-xl font-bold flex items-center justify-center gap-2 ${sharePhotos.length > 0 ? 'bg-gradient-to-r from-purple-600 to-pink-600 text-white' : 'bg-stone-800 text-stone-500'}`}><Download size={20} /> åŒ¯å‡ºåœ–ç‰‡</button>
        <canvas ref={canvasRef} className="hidden" />
      </div></div></div>)}

      {showMenuGuide && (<div className="fixed inset-0 bg-stone-950 z-50 overflow-y-auto flex flex-col animate-fade-in"><div className="sticky top-0 bg-stone-900/95 backdrop-blur border-b border-stone-800 p-4 z-10 space-y-3"><div className="flex justify-between items-center"><div><h2 className="text-xl font-bold text-amber-50">æ”»ç•¥åœ–é‘‘</h2><div className="flex items-center gap-2 text-xs text-stone-400"><span>{isUsingSheet ? "é›²ç«¯åŒæ­¥ä¸­" : "å…§å»ºè³‡æ–™"}</span>{isUsingSheet && <button onClick={() => fetchSheetData(sheetUrl)} className="p-1 bg-stone-800 rounded hover:bg-stone-700"><RefreshCw size={12} /></button>}</div></div><button onClick={() => setShowMenuGuide(false)} className="p-2 bg-stone-800 rounded-full text-stone-400"><X size={20}/></button></div><div className="flex p-1 bg-stone-800 rounded-xl"><button onClick={() => setActiveTab('category')} className={`flex-1 py-2 rounded-lg text-sm font-bold transition-all ${activeTab === 'category' ? 'bg-stone-700 text-white shadow' : 'text-stone-400 hover:text-stone-200'}`}>åˆ†é¡ç€è¦½</button><button onClick={() => setActiveTab('ranking')} className={`flex-1 py-2 rounded-lg text-sm font-bold transition-all flex items-center justify-center gap-1 ${activeTab === 'ranking' ? 'bg-amber-700 text-white shadow' : 'text-stone-400 hover:text-stone-200'}`}><TrendingUp size={14} /> ç²¾ç®—æ’è¡Œ</button></div>{activeTab === 'category' && (<div className="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">{uniqueCategories.map(cat => (<button key={cat} onClick={() => setGuideCategory(cat)} className={`whitespace-nowrap px-4 py-1.5 rounded-full text-xs font-bold border transition-colors ${guideCategory === cat ? 'bg-amber-600 border-amber-600 text-white' : 'bg-stone-900 border-stone-700 text-stone-400 hover:border-stone-500'}`}>{CATEGORY_MAP[cat] || (cat === 'All' ? 'å…¨éƒ¨' : cat)}</button>))}</div>)}<div className="flex justify-between items-center pt-2 border-t border-stone-800"><div className="flex bg-stone-800 rounded-lg p-0.5"><button onClick={() => setSortBy('cp_desc')} className={`px-2 py-1 text-[10px] rounded-md ${sortBy === 'cp_desc' ? 'bg-amber-600 text-white' : 'text-stone-400'}`}>CPå€¼é«˜</button><button onClick={() => setSortBy('price_desc')} className={`px-2 py-1 text-[10px] rounded-md ${sortBy === 'price_desc' ? 'bg-stone-600 text-white' : 'text-stone-400'}`}>æœ€è²´</button><button onClick={() => setSortBy('cal_asc')} className={`px-2 py-1 text-[10px] rounded-md ${sortBy === 'cal_asc' ? 'bg-stone-600 text-white' : 'text-stone-400'}`}>ä½å¡</button></div>{activeTab === 'ranking' && <label className="flex items-center gap-1 text-[10px] text-stone-400"><input type="checkbox" checked={excludeLowCal} onChange={(e) => setExcludeLowCal(e.target.checked)} className="accent-amber-600"/> æ’é™¤èŒ¶æ°´</label>}</div></div><div className="flex-1 p-4 pb-20 overflow-y-auto">{activeTab === 'category' ? (<div className="space-y-6">{uniqueCategories.filter(cat => guideCategory === 'All' || guideCategory === cat).filter(cat => cat !== 'All').map(category => { const items = processGuideItems(menuDB.filter(i => i.category === category)); return (<div key={category} className="animate-fade-in"><h3 className="text-amber-500 font-bold mb-3 uppercase text-sm tracking-wider border-b border-stone-800 pb-1 sticky top-0 bg-stone-950/90 backdrop-blur py-1 z-0">{CATEGORY_MAP[category] || category}</h3><div className="grid gap-3">{items.map((item, idx) => (<div key={idx} className="bg-stone-900 border border-stone-800 rounded-xl p-3 flex justify-between items-start"><div className="flex-1 pr-2"><div className="font-bold text-stone-200 text-sm">{item.name.split('(')[0]}</div><div className="flex items-center gap-2 mt-1"><span className="text-[10px] bg-amber-900/30 text-amber-500 px-1.5 py-0.5 rounded border border-amber-900/50">${item.cp}/kcal</span><span className="text-xs text-stone-500">{item.desc}</span></div></div><div className="text-right shrink-0"><div className="text-amber-400 font-mono font-bold text-sm">${item.displayPrice}</div><div className="text-stone-600 text-xs font-mono">{item.calories} kcal</div></div></div>))}</div></div>); })}</div>) : (<div className="grid gap-2 animate-fade-in">{processGuideItems(menuDB).map((item, idx) => (<div key={idx} className="bg-stone-900 border border-stone-800 rounded-xl p-3 flex items-center gap-3"><div className="w-8 h-8 flex items-center justify-center bg-stone-800 rounded-full font-bold text-stone-500 text-xs">#{idx + 1}</div><div className="flex-1"><div className="font-bold text-stone-200 text-sm">{item.name.split('(')[0]}</div><div className="flex items-center gap-2 mt-1"><span className="text-[10px] bg-amber-900/30 text-amber-500 px-1.5 py-0.5 rounded border border-amber-900/50">${item.cp}/kcal</span><span className="text-xs text-stone-500">{item.desc}</span></div></div><div className="text-right"><div className="text-stone-300 font-mono text-sm">${item.displayPrice}</div><div className="text-stone-600 text-xs font-mono">{item.calories} kcal</div></div></div>))}</div>)}</div></div>)}

      <div className="max-w-md mx-auto p-4">
        {activeTab === 'dashboard' && renderDashboard()}
        {activeTab === 'scan' && (<>{!image && !isEditing && (<div className="flex flex-col items-center justify-center h-[60vh] space-y-6"><div className="flex gap-4"><button onClick={() => cameraInputRef.current.click()} className="w-36 h-36 rounded-2xl bg-stone-900 border-2 border-stone-800 flex flex-col items-center justify-center hover:border-amber-600 transition-all shadow-xl group"><Camera size={36} className="text-stone-400 mb-2 group-hover:text-amber-400 transition-colors" /><span className="text-stone-400 text-sm font-medium group-hover:text-amber-400 transition-colors">æ‹ç…§</span></button><button onClick={() => fileInputRef.current.click()} className="w-36 h-36 rounded-2xl bg-stone-900 border-2 border-stone-800 flex flex-col items-center justify-center hover:border-amber-600 transition-all shadow-xl group"><ImageIcon size={36} className="text-stone-400 mb-2 group-hover:text-amber-400 transition-colors" /><span className="text-stone-400 text-sm font-medium group-hover:text-amber-400 transition-colors">å¾ç›¸ç°¿é¸</span></button></div><input type="file" accept="image/*" capture="environment" ref={cameraInputRef} className="hidden" onChange={handleImageUpload} /><input type="file" accept="image/*" ref={fileInputRef} className="hidden" onChange={handleImageUpload} /><button onClick={startManualInput} className="flex items-center gap-2 text-stone-400 hover:text-amber-400 px-6 py-3 rounded-xl border border-stone-800 hover:bg-stone-900 transition-all"><PenTool size={18} /><span className="font-medium">æ‰‹å‹•è¼¸å…¥</span></button><p className="text-stone-600 text-[10px] text-center max-w-[280px] mt-4">ğŸ“· æˆ‘å€‘ä¸æœƒå„²å­˜ä½ çš„ç…§ç‰‡ã€‚ä½†å› ä½¿ç”¨å…è²» Gemini APIï¼ŒGoogle å¯èƒ½å°‡åœ–ç‰‡ç”¨æ–¼æ¨¡å‹è¨“ç·´ã€‚</p></div>)}{image && !isEditing && !loading && (<div className="space-y-6 animate-fade-in"><div className="relative rounded-2xl overflow-hidden shadow-lg border border-stone-800 group"><img src={image} alt="Food" className="w-full max-h-64 object-cover" /><button onClick={() => setImage(null)} className="absolute top-2 right-2 bg-black/50 p-2 rounded-full text-white"><RotateCcw size={16}/></button></div><button onClick={analyzeImage} className="w-full py-4 rounded-xl font-bold text-lg bg-amber-600 text-white shadow-lg flex items-center justify-center gap-2"><Calculator size={20} /> é–‹å§‹ä¼°åƒ¹</button></div>)}{loading && (<div className="flex flex-col items-center justify-center h-[50vh] space-y-4"><div className="w-12 h-12 border-4 border-stone-800 border-t-amber-600 rounded-full animate-spin"></div><p className="text-stone-400 animate-pulse">AI æ­£åœ¨æ•¸æ•¸...</p></div>)}{isEditing && (<div className="space-y-4 pb-24 animate-fade-in">{image ? (<div className="relative rounded-xl overflow-hidden border border-stone-800"><img src={image} className="w-full object-contain max-h-[50vh]" /><div className="absolute bottom-2 left-1/2 -translate-x-1/2"><span className="bg-black/60 text-white px-3 py-1 rounded-full text-xs backdrop-blur">æœ¬ç›¤åƒ¹å€¼é ä¼° ${calculateTotal(plateItems).price}</span></div></div>) : (<div className="p-4 bg-stone-800 rounded-xl border border-stone-700 text-center mb-2"><p className="text-stone-300 font-bold">ğŸ“ æ‰‹å‹•ç´€éŒ„æ¨¡å¼</p><p className="text-xs text-stone-500 mt-1">ç¸½è¨ˆ: ${calculateTotal(plateItems).price}</p></div>)}<div className="bg-stone-900 rounded-xl border border-stone-800 divide-y divide-stone-800">{plateItems.map((item, idx) => (<div key={idx} className="relative p-3 flex flex-col gap-2"><div className="flex items-center gap-3"><div className="flex-1 relative"><input className="bg-transparent text-stone-200 font-bold text-sm w-full placeholder-stone-600 focus:outline-none focus:border-b border-amber-600" value={item.name} placeholder="è¼¸å…¥èœå..." onChange={(e) => handleNameChange(idx, e.target.value)} onFocus={() => handleNameChange(idx, item.name)} />{activeSuggestionIndex === idx && suggestions.length > 0 && (<div className="absolute top-full left-0 w-full bg-stone-800 border border-stone-700 rounded-lg shadow-2xl z-50 max-h-48 overflow-y-auto mt-1">{suggestions.map((s, sIdx) => (<button key={sIdx} className="w-full text-left p-3 text-xs hover:bg-stone-700 border-b border-stone-700/50 last:border-0 flex justify-between items-center" onMouseDown={(e) => { e.preventDefault(); selectSuggestion(idx, s); }}><div className="font-bold text-stone-200">{s.name}</div><div className="text-right"><div className="text-amber-400">${getDisplayPrice(s)}</div><div className="text-stone-500 text-[10px]">{s.calories} kcal</div></div></button>))}</div>)}</div><div className="flex items-center bg-stone-800 rounded-lg border border-stone-700"><button onClick={() => updateCount(idx, -1)} className="p-2 text-stone-400 hover:text-red-400 hover:bg-red-900/20 rounded-l-lg"><Minus size={14}/></button><span className="w-6 text-center font-mono text-stone-200 text-sm">{item.count}</span><button onClick={() => updateCount(idx, 1)} className="p-2 text-stone-400 hover:text-green-400 hover:bg-green-900/20 rounded-r-lg"><Plus size={14}/></button></div></div><div className="flex flex-wrap gap-2 text-xs"><div className="flex items-center gap-1"><span className="text-stone-500">å¸‚åƒ¹$</span><input type="text" inputMode="numeric" className="bg-stone-800 border border-stone-700 rounded px-2 py-1 w-14 text-amber-400" value={item.price || ''} placeholder="0" onChange={(e) => { const newItems = [...plateItems]; newItems[idx] = {...item, price: Number(e.target.value) || 0}; setPlateItems(newItems); }} /></div><div className="flex items-center gap-1"><span className="text-stone-500">é¤å»³$</span><input type="text" inputMode="numeric" className="bg-stone-800 border border-stone-700 rounded px-2 py-1 w-14 text-amber-400" value={item.restaurantPrice || ''} placeholder="0" onChange={(e) => { const newItems = [...plateItems]; newItems[idx] = {...item, restaurantPrice: Number(e.target.value) || 0}; setPlateItems(newItems); }} /></div><div className="flex items-center gap-1"><input type="text" inputMode="numeric" className="bg-stone-800 border border-stone-700 rounded px-2 py-1 w-14 text-stone-300" value={item.calories || ''} placeholder="0" onChange={(e) => { const newItems = [...plateItems]; newItems[idx] = {...item, calories: Number(e.target.value) || 0}; setPlateItems(newItems); }} /><span className="text-stone-500">kcal</span></div></div><div className="text-xs text-stone-600 text-right">x {item.count} = ${getDisplayPrice(item) * item.count} / {(item.calories || 0) * item.count} kcal</div></div>))}<button onClick={() => setPlateItems([...plateItems, {name: '', price: 0, count: 1, calories: 0, category: 'General'}])} className="w-full p-3 text-xs text-stone-400 hover:bg-stone-800 flex items-center justify-center gap-1"><Plus size={12}/> æ–°å¢é …ç›®</button></div><div className="flex gap-3"><button onClick={() => {setImage(null); setIsEditing(false); setPlateItems([])}} className="flex-1 py-3 rounded-xl border border-stone-700 text-stone-400 text-sm">å–æ¶ˆ</button><button onClick={confirmPlate} className="flex-[2] py-3 rounded-xl bg-green-600 text-white font-bold shadow-lg shadow-green-900/20 flex items-center justify-center gap-2"><Check size={18} /> ç¢ºèªå­˜å…¥</button></div></div>)}</>)}
        {activeTab === 'history' && renderHistory()}
        {activeTab === 'leaderboard' && renderLeaderboard()}
        {activeTab === 'strategy' && renderStrategy()}
      </div>

      <div className="fixed bottom-0 inset-x-0 bg-stone-950/90 backdrop-blur border-t border-stone-800 p-2 flex justify-around z-40 pb-safe">
        <button onClick={() => setActiveTab('dashboard')} className={`flex flex-col items-center p-2 rounded-xl transition-colors ${activeTab === 'dashboard' ? 'text-amber-500' : 'text-stone-500 hover:text-stone-300'}`}><LayoutDashboard size={24} /><span className="text-[10px] font-bold mt-1">æˆ°æƒ…å®¤</span></button>
        <button onClick={() => setActiveTab('scan')} className={`flex flex-col items-center p-2 rounded-xl transition-colors ${activeTab === 'scan' ? 'text-amber-500' : 'text-stone-500 hover:text-stone-300'}`}><Camera size={24} /><span className="text-[10px] font-bold mt-1">é–‹åƒ</span></button>
        <button onClick={() => setActiveTab('history')} className={`flex flex-col items-center p-2 rounded-xl transition-colors ${activeTab === 'history' ? 'text-amber-500' : 'text-stone-500 hover:text-stone-300'}`}><HistoryIcon size={24} /><span className="text-[10px] font-bold mt-1">ç´€éŒ„</span></button>
        <button onClick={() => setActiveTab('leaderboard')} className={`flex flex-col items-center p-2 rounded-xl transition-colors ${activeTab === 'leaderboard' ? 'text-amber-500' : 'text-stone-500 hover:text-stone-300'}`}><Trophy size={24} /><span className="text-[10px] font-bold mt-1">æ’è¡Œ</span></button>
        <button onClick={() => setActiveTab('strategy')} className={`flex flex-col items-center p-2 rounded-xl transition-colors ${activeTab === 'strategy' ? 'text-amber-500' : 'text-stone-500 hover:text-stone-300'}`}><Target size={24} /><span className="text-[10px] font-bold mt-1">ç­–ç•¥</span></button>
      </div>

      <style>{`@keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } } .animate-fade-in { animation: fade-in 0.3s ease-out forwards; } .pb-safe { padding-bottom: env(safe-area-inset-bottom); }`}</style>
    </div>
  );
};

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<NagomiApp />);
    </script>
</body>
</html>
