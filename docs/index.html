<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0c0a09">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>NAGOMI æˆ°æƒ…å®¤</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; background: #0c0a09; -webkit-tap-highlight-color: transparent; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #1c1917; }
        ::-webkit-scrollbar-thumb { background: #44403c; border-radius: 2px; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
const { useState, useEffect, useRef } = React;

// Simple SVG Icon Components
const Icon = ({ d, size = 24, className = '' }) => (
  <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d={d}/></svg>
);
const Camera = ({ size, className }) => <Icon size={size} className={className} d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z M12 17a4 4 0 1 0 0-8 4 4 0 0 0 0 8z" />;
const Calculator = ({ size, className }) => <Icon size={size} className={className} d="M4 2h16a2 2 0 0 1 2 2v16a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2z M8 6h8" />;
const RotateCcw = ({ size, className }) => <Icon size={size} className={className} d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8 M3 3v5h5" />;
const Settings = ({ size, className }) => <Icon size={size} className={className} d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z" />;
const Zap = ({ size, className }) => <Icon size={size} className={className} d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" />;
const BookOpen = ({ size, className }) => <Icon size={size} className={className} d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z" />;
const X = ({ size, className }) => <Icon size={size} className={className} d="M18 6L6 18 M6 6l12 12" />;
const RefreshCw = ({ size, className }) => <Icon size={size} className={className} d="M23 4v6h-6 M1 20v-6h6" />;
const TrendingUp = ({ size, className }) => <Icon size={size} className={className} d="M23 6l-9.5 9.5-5-5L1 18 M17 6h6v6" />;
const DollarSign = ({ size, className }) => <Icon size={size} className={className} d="M12 1v22 M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 1 1 0 7H6" />;
const Utensils = ({ size, className }) => <Icon size={size} className={className} d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2 M7 2v20" />;
const Plus = ({ size, className }) => <Icon size={size} className={className} d="M12 5v14 M5 12h14" />;
const Minus = ({ size, className }) => <Icon size={size} className={className} d="M5 12h14" />;
const Check = ({ size, className }) => <Icon size={size} className={className} d="M20 6L9 17l-5-5" />;
const LayoutDashboard = ({ size, className }) => <Icon size={size} className={className} d="M3 3h7v9H3z M14 3h7v5h-7z M14 12h7v9h-7z M3 16h7v5H3z" />;
const HistoryIcon = ({ size, className }) => <Icon size={size} className={className} d="M12 8v4l3 3 M3.05 11a9 9 0 1 1 .5 4m-.5 5v-5h5" />;
const Droplets = ({ size, className }) => <Icon size={size} className={className} d="M7 16.3c2.2 0 4-1.83 4-4.05 0-1.16-.57-2.26-1.71-3.19S7.29 6.75 7 5.3c-.29 1.45-1.14 2.84-2.29 3.76S3 11.1 3 12.25c0 2.22 1.8 4.05 4 4.05z" />;
const Clock = ({ size, className }) => <Icon size={size} className={className} d="M12 22c5.52 0 10-4.48 10-10S17.52 2 12 2 2 6.48 2 12s4.48 10 10 10z M12 6v6l4 2" />;
const PenTool = ({ size, className }) => <Icon size={size} className={className} d="M12 19l7-7 3 3-7 7-3-3z" />;
const Timer = ({ size, className }) => <Icon size={size} className={className} d="M10 2h4 M12 14l3-3 M12 22a8 8 0 1 0 0-16 8 8 0 0 0 0 16z" />;
const Coins = ({ size, className }) => <Icon size={size} className={className} d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2z M12 6v6l4 2" />;

const VERCEL_API_URL = "https://eatawarescheduler.vercel.app/api/analyze";
const PRESET_SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ57HSiS9fzVpSA6rEhhWJNMhgsxJce-wq0_qBSXx3AYdngzJGUlqszgqgfjdyt3gBYApXZewmhWudc/pub?gid=0&single=true&output=csv";
const DEFAULT_SETTINGS = { lunchPrice: 1380, dinnerPrice: 1580, calorieGoal: 2500, liquidGoal: 4 };
const CATEGORY_MAP = { 'Sashimi': 'ç¾åˆ‡åˆºèº«', 'Sushi': 'å£½å¸æ‰‹å·', 'Kobachi': 'æ‡·çŸ³å°ç¼½', 'Yakimono': 'è·äººçƒ¤ç‰©', 'Agemono': 'ç‚¸ç‰©å¤©å©¦ç¾…', 'Soup': 'æ¹¯å“/é‹ç‰©', 'Steamed Dish': 'è’¸ç‰©', 'Cooked Dish': 'ç†±èœ/éµæ¿', 'Drink': 'é£²å“é…’æ°´', 'Dessert': 'ç²¾ç·»ç”œé»' };
const DEFAULT_MENU_DB = [
  { category: 'Sashimi', name: 'é®­é­š (Salmon)', price: 70, restaurantPrice: 120, calories: 55, desc: 'ç¾é»ç¾åˆ‡çš„åŸºæœ¬é­šç¨®' },
  { category: 'Sashimi', name: 'ç´…é­½ (Amberjack)', price: 80, restaurantPrice: 150, calories: 45, desc: 'é…åˆæ™‚ä»¤ä¾›æ‡‰çš„é­šç¨®' },
  { category: 'Sushi', name: 'ç‚™ç‡’å¹²è²æ¡å£½å¸', price: 100, restaurantPrice: 180, calories: 45, desc: 'ç”Ÿé£Ÿç´šå¹²è²ï¼Œé®®ç”œ' },
  { category: 'Yakimono', name: 'é¦™é­šå§¿ç‡’', price: 180, restaurantPrice: 280, calories: 220, desc: 'ä¸²æ³¢æŠ€æ³•ï¼ŒNAGOMI å¿…åƒ' },
  { category: 'Agemono', name: 'å»£å³¶ç‚¸ç‰¡è £', price: 100, restaurantPrice: 160, calories: 140, desc: 'çˆ†æ¼¿é®®å‘³ï¼Œå¿…æ¶' },
  { category: 'Drink', name: 'ä¸‰å¾—åˆ©é ‚ç´šç”Ÿå•¤', price: 180, restaurantPrice: 250, calories: 140, desc: 'ç„¡é™æš¢é£²ï¼Œç¥ç´šæ³¡æ²«' },
];

const parseCSVLine = (line) => { const r = []; let f = '', q = false; for (let c = 0; c < line.length; c++) { const ch = line[c]; if (ch === '"') { if (c + 1 < line.length && line[c + 1] === '"') { f += '"'; c++; } else { q = !q; } } else if (ch === ',' && !q) { r.push(f); f = ''; } else { f += ch; } } r.push(f); return r; };
const parseCSV = (csvText) => { const lines = csvText.split(/\r?\n/); const result = []; if (lines.length === 0) return result; const headers = parseCSVLine(lines[0].trim()).map(h => h.trim().toLowerCase()); const colMap = { category: headers.findIndex(h => h.includes('category') || h.includes('åˆ†é¡')), name: headers.findIndex(h => h.includes('name') || h.includes('å“å')), price: headers.findIndex(h => (h.includes('price') || h.includes('å¸‚åƒ¹')) && !h.includes('restaurant') && !h.includes('hotel') && !h.includes('å®šåƒ¹')), restaurantPrice: headers.findIndex(h => h.includes('restaurant') || h.includes('å®šåƒ¹') || h.includes('é£¯åº—') || h.includes('hotel')), calories: headers.findIndex(h => h.includes('calor') || h.includes('ç†±é‡')), desc: headers.findIndex(h => h.includes('desc') || h.includes('æè¿°')) }; if (colMap.category === -1) { colMap.category = 0; colMap.name = 1; colMap.price = 2; colMap.calories = 3; colMap.desc = 4; colMap.restaurantPrice = 5; } for (let i = 1; i < lines.length; i++) { const line = lines[i].trim(); if (!line) continue; const row = parseCSVLine(line); if (row.length > 2) { const price = Number(row[colMap.price]?.trim()); const rp = Number(row[colMap.restaurantPrice]?.trim()); result.push({ category: row[colMap.category]?.trim() || '', name: row[colMap.name]?.trim() || '', price: !isNaN(price) ? price : 0, restaurantPrice: !isNaN(rp) ? rp : 0, calories: Number(row[colMap.calories]?.trim()) || 0, desc: row[colMap.desc]?.trim() || '' }); } } return result; };
const generateSystemPrompt = (menuDB) => { const menuString = menuDB.map(item => `- ${item.name}: ~${item.price > 0 ? item.price : Math.round(item.restaurantPrice/1.5)}`).join('\n'); return `Context: User is eating at NAGOMI Buffet. Goal: Identify food, count items, estimate value.\nDB:\n${menuString}\nInstructions:\n1. Identify items.\n2. ESTIMATE COUNT (e.g., 3 slices). Default 1.\n3. Return JSON: { items: [{name, price, calories, count}], comment }`; };

const ProgressBar = ({ current, total, colorClass, label, unit = '', icon: Icon }) => {
  const rawPct = total > 0 ? (current / total) * 100 : 0; const displayPct = Math.round(rawPct); const visualW = Math.min(100, Math.max(0, rawPct)); const isOver = rawPct >= 100; const isSuperOver = rawPct >= 200;
  return (<div className={`p-4 rounded-xl border transition-colors duration-500 ${isSuperOver ? 'bg-red-900/20 border-red-500/30' : 'bg-stone-900/50 border-stone-800'}`}><div className="flex justify-between items-end mb-2"><div className="flex items-center gap-2 text-stone-400 text-xs font-medium uppercase tracking-wider">{Icon && <Icon size={14} className={isOver ? 'text-amber-400 animate-pulse' : ''} />}{label}</div><div className="text-right"><div className="flex items-baseline justify-end gap-1"><span className={`text-lg font-black transition-colors ${isOver ? 'text-amber-400' : 'text-stone-200'}`}>{current.toLocaleString()}</span><span className="text-xs text-stone-500"> / {total.toLocaleString()}{unit}</span></div></div></div><div className="h-2.5 w-full bg-stone-800 rounded-full overflow-hidden relative"><div className={`h-full rounded-full transition-all duration-1000 ${colorClass} ${isOver ? 'shadow-[0_0_12px_currentColor] brightness-110' : ''}`} style={{ width: `${visualW}%` }}></div>{isOver && <div className="absolute inset-0 bg-white/20 animate-pulse"></div>}</div><div className="flex justify-between items-center mt-1.5"><span className={`text-[10px] font-medium ${isSuperOver ? 'text-red-400' : isOver ? 'text-amber-500' : 'text-stone-500'}`}>{isSuperOver ? 'ğŸ”¥ é›™å€å›æœ¬ï¼å¤ªç¥å•¦ï¼' : isOver ? 'ğŸ‰ ç›®æ¨™é”æˆï¼è³ºåˆ°äº†' : 'åŠ æ²¹ï¼Œé‚„å·®ä¸€é»'}</span><div className={`text-xs font-bold flex items-center gap-1 ${isOver ? 'text-amber-400' : 'text-stone-400'}`}>{displayPct}%{isOver && <TrendingUp size={12} />}</div></div></div>);
};

const TimeRemaining = () => {
  const [timeLeft, setTimeLeft] = useState(''); const [session, setSession] = useState(''); const [progress, setProgress] = useState(0); const [isUrgent, setIsUrgent] = useState(false);
  useEffect(() => { const updateTimer = () => { const now = new Date(); const currentTime = now.getHours() * 60 + now.getMinutes(); const lunchStart = 690, lunchEnd = 900, dinnerStart = 1050, dinnerEnd = 1290; let start = 0, end = 0, sess = 'éç”¨é¤æ™‚æ®µ'; if (currentTime >= lunchStart && currentTime < lunchEnd) { start = lunchStart; end = lunchEnd; sess = 'åˆé¤æ™‚æ®µ'; } else if (currentTime >= dinnerStart && currentTime < dinnerEnd) { start = dinnerStart; end = dinnerEnd; sess = 'æ™šé¤æ™‚æ®µ'; } else { setSession('ä¼‘æ¯ä¸­'); setTimeLeft('--:--'); setProgress(0); return; } setSession(sess); const elapsed = currentTime - start; const remaining = end - currentTime; setProgress(Math.min(100, Math.max(0, (elapsed / (end - start)) * 100))); setTimeLeft(`${Math.floor(remaining / 60)}å°æ™‚ ${remaining % 60}åˆ†`); setIsUrgent(remaining <= 30); }; updateTimer(); const interval = setInterval(updateTimer, 60000); return () => clearInterval(interval); }, []);
  let progressColor = 'bg-emerald-500'; if (progress > 50) progressColor = 'bg-yellow-500'; if (progress > 85) progressColor = 'bg-red-500 animate-pulse';
  return (<div className={`p-4 rounded-xl border flex flex-col justify-between shadow-lg transition-colors ${isUrgent ? 'bg-red-950/30 border-red-500/50' : 'bg-gradient-to-br from-stone-800 to-stone-900 border-stone-700'}`}><div className="flex justify-between items-center mb-3"><div><div className={`text-xs font-bold uppercase tracking-wider mb-1 ${isUrgent ? 'text-red-400' : 'text-stone-400'}`}>{session} å€’æ•¸</div><div className={`text-3xl font-black font-mono tracking-tight ${isUrgent ? 'text-red-400' : 'text-stone-200'}`}>{timeLeft}</div></div><div className={`p-2 rounded-full ${isUrgent ? 'bg-red-500/20 text-red-400 animate-bounce' : 'bg-stone-800 text-stone-500'}`}>{isUrgent ? <Timer size={24} /> : <Clock size={24} />}</div></div><div className="w-full"><div className="flex justify-between text-[10px] text-stone-500 mb-1"><span>å·²ç”¨ {Math.round(progress)}%</span><span>å‰©é¤˜æ™‚é–“</span></div><div className="h-1.5 w-full bg-stone-950 rounded-full overflow-hidden"><div className={`h-full rounded-full transition-all duration-1000 ${progressColor}`} style={{ width: `${progress}%` }}></div></div></div></div>);
};

const NagomiApp = () => {
  const [activeTab, setActiveTab] = useState('dashboard'); const [history, setHistory] = useState([]); const [apiKey, setApiKey] = useState(''); const [sheetUrl, setSheetUrl] = useState(PRESET_SHEET_URL); const [menuDB, setMenuDB] = useState(DEFAULT_MENU_DB); const [priceMode, setPriceMode] = useState('market'); const [userSettings, setUserSettings] = useState(DEFAULT_SETTINGS); const [showSettings, setShowSettings] = useState(false); const [showMenuGuide, setShowMenuGuide] = useState(false); const [isUsingSheet, setIsUsingSheet] = useState(false); const [image, setImage] = useState(null); const [loading, setLoading] = useState(false); const [plateItems, setPlateItems] = useState([]); const [isEditing, setIsEditing] = useState(false); const fileInputRef = useRef(null); const [activeSuggestionIndex, setActiveSuggestionIndex] = useState(null); const [suggestions, setSuggestions] = useState([]); const [guideCategory, setGuideCategory] = useState('All'); const [excludeLowCal, setExcludeLowCal] = useState(true); const [sortBy, setSortBy] = useState('cp_desc');

  const fetchSheetData = async (url) => { if (!url) return; try { const response = await fetch(url); if (!response.ok) throw new Error('Network error'); const text = await response.text(); const parsedData = parseCSV(text); if (parsedData.length > 0) { setMenuDB(parsedData); setIsUsingSheet(true); } } catch (error) { console.error("Sheet error", error); setIsUsingSheet(false); setMenuDB(DEFAULT_MENU_DB); } };

  useEffect(() => { const storedKey = localStorage.getItem('gemini_api_key'); const storedSettings = localStorage.getItem('nagomi_user_settings'); const storedHistory = localStorage.getItem('nagomi_history'); const storedSheetUrl = localStorage.getItem('nagomi_sheet_url'); const storedPriceMode = localStorage.getItem('nagomi_price_mode'); if (storedKey) setApiKey(storedKey); else if (!VERCEL_API_URL) setShowSettings(true); if (storedSettings) setUserSettings(JSON.parse(storedSettings)); if (storedHistory) setHistory(JSON.parse(storedHistory)); if (storedPriceMode) setPriceMode(storedPriceMode); const targetUrl = storedSheetUrl || PRESET_SHEET_URL; setSheetUrl(targetUrl); if (targetUrl) fetchSheetData(targetUrl); }, []);
  useEffect(() => { localStorage.setItem('nagomi_history', JSON.stringify(history)); }, [history]);

  const saveGlobalSettings = () => { localStorage.setItem('gemini_api_key', apiKey.trim()); localStorage.setItem('nagomi_sheet_url', sheetUrl); localStorage.setItem('nagomi_user_settings', JSON.stringify(userSettings)); if (sheetUrl) fetchSheetData(sheetUrl); setShowSettings(false); };
  const getDisplayPrice = (item) => priceMode === 'restaurant' ? (item.restaurantPrice > 0 ? item.restaurantPrice : Math.round(item.price * 1.5)) : (item.price > 0 ? item.price : Math.round(item.restaurantPrice / 1.5));
  const calculateTotal = (items) => items.reduce((acc, item) => { const dbItem = menuDB.find(db => db.name === item.name) || item; const unitPrice = getDisplayPrice(dbItem.price !== undefined ? dbItem : item); const cals = dbItem.calories || item.calories || 0; return { price: acc.price + (unitPrice * (item.count || 1)), calories: acc.calories + (cals * (item.count || 1)), liquids: acc.liquids + (item.category === 'Drink' || item.name.includes('é…’') || item.name.includes('èŒ¶') || item.name.includes('é£²') ? (item.count || 1) : 0) }; }, { price: 0, calories: 0, liquids: 0 });

  const handleImageUpload = (e) => { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onloadend = () => { setImage(reader.result); setPlateItems([]); setIsEditing(false); setActiveTab('scan'); }; reader.readAsDataURL(file); } };
  const startManualInput = () => { setPlateItems([{ name: '', price: 0, calories: 0, count: 1, category: 'General' }]); setImage(null); setIsEditing(true); };

  const analyzeImage = async () => { if (!VERCEL_API_URL && !apiKey) { alert("è«‹å…ˆè¨­å®š API Key"); setShowSettings(true); return; } setLoading(true); try { const base64Image = image.split(',')[1]; let result; if (VERCEL_API_URL) { const response = await fetch(VERCEL_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ image: base64Image, menuDB }) }); const data = await response.json(); if (data.error) throw new Error(data.error); result = data; } else { const payload = { contents: [{ parts: [{ text: generateSystemPrompt(menuDB) }, { text: "Analyze image. Return JSON: { items: [{name, price, calories, count}], comment }" }, { inline_data: { mime_type: "image/jpeg", data: base64Image } }] }], generationConfig: { response_mime_type: "application/json" } }; const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey.trim()}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); const data = await response.json(); if (data.error) throw new Error(data.error.message); result = JSON.parse(data.candidates[0].content.parts[0].text); } const enhancedItems = result.items.map(i => { const dbMatch = menuDB.find(d => d.name.includes(i.name) || i.name.includes(d.name)); return { ...i, category: dbMatch?.category || 'General', price: dbMatch?.price || i.price, restaurantPrice: dbMatch?.restaurantPrice || 0, calories: dbMatch?.calories || i.calories, count: i.count || 1 }; }); setPlateItems(enhancedItems); setIsEditing(true); } catch (e) { alert("Error: " + e.message); } finally { setLoading(false); } };

  const confirmPlate = () => { if (plateItems.length === 0) return; const validItems = plateItems.filter(i => i.name.trim() !== ''); if (validItems.length === 0) return; setHistory([...history, ...validItems]); setPlateItems([]); setImage(null); setIsEditing(false); setActiveTab('dashboard'); };
  const handleNameChange = (index, val) => { const newItems = [...plateItems]; newItems[index].name = val; setPlateItems(newItems); if (val.trim()) { setSuggestions(menuDB.filter(db => db.name.toLowerCase().includes(val.toLowerCase())).slice(0, 6)); setActiveSuggestionIndex(index); } else { setSuggestions([]); setActiveSuggestionIndex(null); } };
  const selectSuggestion = (index, dbItem) => { const newItems = [...plateItems]; newItems[index] = { ...newItems[index], name: dbItem.name, price: dbItem.price, restaurantPrice: dbItem.restaurantPrice, calories: dbItem.calories, category: dbItem.category }; setPlateItems(newItems); setActiveSuggestionIndex(null); setSuggestions([]); };
  const updateCount = (index, delta) => { setPlateItems(prev => prev.map((item, i) => i === index ? { ...item, count: Math.max(0, (item.count || 1) + delta) } : item).filter(item => item.count > 0)); };

  const processGuideItems = (items) => { let processed = items.map(item => ({ ...item, displayPrice: getDisplayPrice(item), cp: item.calories > 0 ? (getDisplayPrice(item) / item.calories).toFixed(2) : 0 })); if (excludeLowCal && activeTab === 'ranking') processed = processed.filter(item => item.calories > 5); if (activeTab === 'ranking') processed = processed.filter(item => item.displayPrice > 0); return processed.sort((a, b) => sortBy === 'cp_desc' ? b.cp - a.cp : sortBy === 'price_desc' ? b.displayPrice - a.displayPrice : a.calories - b.calories); };
  const uniqueCategories = ['All', ...new Set(menuDB.map(item => item.category))];

  const renderDashboard = () => { const totalStats = calculateTotal(history); const hour = new Date().getHours(); const budget = (hour >= 11 && hour < 16) ? userSettings.lunchPrice : userSettings.dinnerPrice; return (<div className="space-y-4 animate-fade-in pb-24"><TimeRemaining /><div className="grid grid-cols-2 gap-3"><div className="bg-stone-900 border border-stone-800 p-4 rounded-xl"><div className="text-xs text-stone-500 mb-1">ç›®å‰ç´¯è¨ˆåƒ¹å€¼ ({priceMode === 'restaurant' ? 'é¤å»³åƒ¹' : 'å¸‚åƒ¹'})</div><div className="text-3xl font-black text-amber-400">${totalStats.price.toLocaleString()}</div></div><div className="bg-stone-900 border border-stone-800 p-4 rounded-xl"><div className="text-xs text-stone-500 mb-1">å·²åƒé …ç›®æ•¸</div><div className="text-3xl font-black text-stone-200">{history.reduce((a,b)=>a+(b.count||1),0)} <span className="text-sm text-stone-500">é“</span></div></div></div><h3 className="text-stone-400 text-xs font-bold uppercase tracking-widest mt-4 px-1">æˆ°æ³åˆ†æ</h3><ProgressBar current={totalStats.price} total={budget} label="å›æœ¬é€²åº¦" unit="å…ƒ" colorClass="bg-gradient-to-r from-amber-600 to-yellow-500" icon={DollarSign}/><ProgressBar current={totalStats.calories} total={userSettings.calorieGoal} label="ç†±é‡é¡åº¦" unit=" kcal" colorClass="bg-gradient-to-r from-green-600 to-emerald-400" icon={Zap}/><ProgressBar current={totalStats.liquids} total={userSettings.liquidGoal} label="æ¶²é«”æ”å–" unit=" æ¯" colorClass="bg-gradient-to-r from-blue-600 to-cyan-400" icon={Droplets}/><div className="mt-6 p-4 bg-stone-900 rounded-xl border border-stone-800"><h4 className="text-stone-300 font-bold mb-2 text-sm">ç›®å‰æ”»ç•¥å»ºè­°</h4><p className="text-xs text-stone-500 leading-relaxed">{totalStats.price < budget ? "åŠ æ²¹ï¼é‚„æ²’å›æœ¬ï¼Œå»ºè­°å¤šæ‹¿äº›ã€Œç‚™ç‡’å¹²è²ã€æˆ–ã€Œé¦™é­šã€ã€‚" : "å¤ªå¼·äº†ï¼å·²ç¶“å›æœ¬ï¼Œç¾åœ¨é–‹å§‹æ˜¯è³ºåˆ°çš„ï¼Œå¯ä»¥äº«å—ä¸€äº›ç²¾ç·»ç”œé»å›‰ï¼"}{totalStats.calories > userSettings.calorieGoal * 0.8 && " ç†±é‡å¿«è¶…æ¨™äº†ï¼Œå»ºè­°é¿é–‹æ¾±ç²‰é¡ã€‚"}</p></div></div>); };

  const renderHistory = () => (<div className="animate-fade-in pb-24"><h3 className="text-xl font-bold text-stone-200 mb-4 px-2">ä»Šæ—¥æˆ°ç¸¾</h3>{history.length === 0 ? (<div className="text-center text-stone-500 py-20">é‚„æ²’æœ‰ç´€éŒ„ï¼Œå¿«å»é–‹åƒï¼</div>) : (<div className="bg-stone-900 rounded-2xl border border-stone-800 overflow-hidden"><div className="divide-y divide-stone-800">{history.map((item, idx) => (<div key={idx} className="p-4 flex justify-between items-center"><div><div className="text-stone-200 font-bold text-sm">{item.name}</div><div className="text-stone-500 text-xs flex gap-2"><span>x{item.count}</span><span>{item.calories * item.count} kcal</span></div></div><div className="text-amber-400 font-mono font-bold">${getDisplayPrice(item) * item.count}</div></div>))}<div className="p-4 bg-stone-950 flex justify-between items-center text-stone-400 text-sm font-bold"><span>ç¸½è¨ˆ ({priceMode === 'restaurant' ? 'é¤å»³åƒ¹' : 'å¸‚åƒ¹'})</span><span>${calculateTotal(history).price}</span></div></div><button onClick={() => {if(confirm("ç¢ºå®šè¦æ¸…ç©ºç´€éŒ„å—ï¼Ÿ")) setHistory([])}} className="w-full p-4 text-xs text-red-500 hover:bg-stone-800 border-t border-stone-800">æ¸…ç©ºæ­·å²ç´€éŒ„</button></div>)}</div>);

  return (
    <div className="min-h-screen bg-stone-950 text-stone-100 font-sans selection:bg-amber-900">
      <div className="bg-stone-950 p-4 border-b border-stone-800 flex justify-between items-center sticky top-0 z-30">
        <div className="flex items-center gap-2"><div className="bg-amber-600 p-2 rounded-lg"><Coins size={20} className="text-white" /></div><h1 className="font-bold text-lg tracking-wide text-amber-50">EAS (Eat Aware Scheduler)</h1></div>
        <div className="flex gap-2 items-center">
          <button onClick={() => { const newMode = priceMode === 'market' ? 'restaurant' : 'market'; setPriceMode(newMode); localStorage.setItem('nagomi_price_mode', newMode); }} className={`flex items-center gap-1 px-3 py-1.5 rounded-lg text-[10px] font-bold border transition-all ${priceMode === 'restaurant' ? 'bg-amber-900/30 border-amber-600 text-amber-500' : 'bg-stone-800 border-stone-700 text-stone-400'}`}>{priceMode === 'restaurant' ? <Utensils size={12} /> : <DollarSign size={12} />}{priceMode === 'restaurant' ? 'é¤å»³åƒ¹' : 'å¸‚åƒ¹'}</button>
          <button onClick={() => setShowMenuGuide(true)} className="p-2 text-stone-400 hover:text-amber-400"><BookOpen size={20} /></button>
          <button onClick={() => setShowSettings(true)} className="p-2 text-stone-400 hover:text-amber-400"><Settings size={20} /></button>
        </div>
      </div>

      {showSettings && (<div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4"><div className="bg-stone-900 border border-stone-700 p-6 rounded-2xl w-full max-w-sm space-y-4"><div className="flex justify-between items-center"><h3 className="font-bold text-amber-50">è¨­å®š</h3><button onClick={() => setShowSettings(false)}><X size={20} className="text-stone-500"/></button></div><div className="space-y-3 text-sm">{!VERCEL_API_URL && (<div><label className="text-stone-400 block mb-1">API Key</label><input type="password" className="w-full bg-stone-950 border border-stone-800 rounded p-2" value={apiKey} onChange={e=>setApiKey(e.target.value)}/></div>)}{VERCEL_API_URL && (<div className="p-2 bg-green-900/20 border border-green-800 rounded text-xs text-green-400">å®‰å…¨æ¨¡å¼ï¼šAPI Key ç”±ä¼ºæœå™¨ç®¡ç†</div>)}<div className="grid grid-cols-2 gap-2"><div><label className="text-stone-400 block mb-1">åˆé¤åƒ¹æ ¼</label><input type="number" className="w-full bg-stone-950 border border-stone-800 rounded p-2" value={userSettings.lunchPrice} onChange={e=>setUserSettings({...userSettings, lunchPrice: Number(e.target.value)})}/></div><div><label className="text-stone-400 block mb-1">æ™šé¤åƒ¹æ ¼</label><input type="number" className="w-full bg-stone-950 border border-stone-800 rounded p-2" value={userSettings.dinnerPrice} onChange={e=>setUserSettings({...userSettings, dinnerPrice: Number(e.target.value)})}/></div></div><div><label className="text-stone-400 block mb-1">ç›®æ¨™ç†±é‡ (kcal)</label><input type="number" className="w-full bg-stone-950 border border-stone-800 rounded p-2" value={userSettings.calorieGoal} onChange={e=>setUserSettings({...userSettings, calorieGoal: Number(e.target.value)})}/></div><div><label className="text-stone-400 block mb-1">æ¶²é«”ç›®æ¨™ (æ¯)</label><input type="number" className="w-full bg-stone-950 border border-stone-800 rounded p-2" value={userSettings.liquidGoal} onChange={e=>setUserSettings({...userSettings, liquidGoal: Number(e.target.value)})}/></div></div><button onClick={saveGlobalSettings} className="w-full bg-amber-600 text-white py-3 rounded-xl font-bold">å„²å­˜è¨­å®š</button></div></div>)}

      {showMenuGuide && (<div className="fixed inset-0 bg-stone-950 z-50 overflow-y-auto flex flex-col animate-fade-in"><div className="sticky top-0 bg-stone-900/95 backdrop-blur border-b border-stone-800 p-4 z-10 space-y-3"><div className="flex justify-between items-center"><div><h2 className="text-xl font-bold text-amber-50">æ”»ç•¥åœ–é‘‘</h2><div className="flex items-center gap-2 text-xs text-stone-400"><span>{isUsingSheet ? "é›²ç«¯åŒæ­¥ä¸­" : "å…§å»ºè³‡æ–™"}</span>{isUsingSheet && <button onClick={() => fetchSheetData(sheetUrl)} className="p-1 bg-stone-800 rounded hover:bg-stone-700"><RefreshCw size={12} /></button>}</div></div><button onClick={() => setShowMenuGuide(false)} className="p-2 bg-stone-800 rounded-full text-stone-400"><X size={20}/></button></div><div className="flex p-1 bg-stone-800 rounded-xl"><button onClick={() => setActiveTab('category')} className={`flex-1 py-2 rounded-lg text-sm font-bold transition-all ${activeTab === 'category' ? 'bg-stone-700 text-white shadow' : 'text-stone-400 hover:text-stone-200'}`}>åˆ†é¡ç€è¦½</button><button onClick={() => setActiveTab('ranking')} className={`flex-1 py-2 rounded-lg text-sm font-bold transition-all flex items-center justify-center gap-1 ${activeTab === 'ranking' ? 'bg-amber-700 text-white shadow' : 'text-stone-400 hover:text-stone-200'}`}><TrendingUp size={14} /> ç²¾ç®—æ’è¡Œ</button></div>{activeTab === 'category' && (<div className="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">{uniqueCategories.map(cat => (<button key={cat} onClick={() => setGuideCategory(cat)} className={`whitespace-nowrap px-4 py-1.5 rounded-full text-xs font-bold border transition-colors ${guideCategory === cat ? 'bg-amber-600 border-amber-600 text-white' : 'bg-stone-900 border-stone-700 text-stone-400 hover:border-stone-500'}`}>{CATEGORY_MAP[cat] || (cat === 'All' ? 'å…¨éƒ¨' : cat)}</button>))}</div>)}<div className="flex justify-between items-center pt-2 border-t border-stone-800"><div className="flex bg-stone-800 rounded-lg p-0.5"><button onClick={() => setSortBy('cp_desc')} className={`px-2 py-1 text-[10px] rounded-md ${sortBy === 'cp_desc' ? 'bg-amber-600 text-white' : 'text-stone-400'}`}>CPå€¼é«˜</button><button onClick={() => setSortBy('price_desc')} className={`px-2 py-1 text-[10px] rounded-md ${sortBy === 'price_desc' ? 'bg-stone-600 text-white' : 'text-stone-400'}`}>æœ€è²´</button><button onClick={() => setSortBy('cal_asc')} className={`px-2 py-1 text-[10px] rounded-md ${sortBy === 'cal_asc' ? 'bg-stone-600 text-white' : 'text-stone-400'}`}>ä½å¡</button></div>{activeTab === 'ranking' && <label className="flex items-center gap-1 text-[10px] text-stone-400"><input type="checkbox" checked={excludeLowCal} onChange={(e) => setExcludeLowCal(e.target.checked)} className="accent-amber-600"/> æ’é™¤èŒ¶æ°´</label>}</div></div><div className="flex-1 p-4 pb-20 overflow-y-auto">{activeTab === 'category' ? (<div className="space-y-6">{uniqueCategories.filter(cat => guideCategory === 'All' || guideCategory === cat).filter(cat => cat !== 'All').map(category => { const items = processGuideItems(menuDB.filter(i => i.category === category)); return (<div key={category} className="animate-fade-in"><h3 className="text-amber-500 font-bold mb-3 uppercase text-sm tracking-wider border-b border-stone-800 pb-1 sticky top-0 bg-stone-950/90 backdrop-blur py-1 z-0">{CATEGORY_MAP[category] || category}</h3><div className="grid gap-3">{items.map((item, idx) => (<div key={idx} className="bg-stone-900 border border-stone-800 rounded-xl p-3 flex justify-between items-start"><div className="flex-1 pr-2"><div className="font-bold text-stone-200 text-sm">{item.name.split('(')[0]}</div><div className="text-xs text-stone-500 mt-1">{item.desc}</div></div><div className="text-right shrink-0"><div className="text-amber-400 font-mono font-bold text-sm">${item.displayPrice}</div><div className="text-stone-600 text-xs font-mono">{item.calories} kcal</div></div></div>))}</div></div>); })}</div>) : (<div className="grid gap-2 animate-fade-in">{processGuideItems(menuDB).map((item, idx) => (<div key={idx} className="bg-stone-900 border border-stone-800 rounded-xl p-3 flex items-center gap-3"><div className="w-8 h-8 flex items-center justify-center bg-stone-800 rounded-full font-bold text-stone-500 text-xs">#{idx + 1}</div><div className="flex-1"><div className="font-bold text-stone-200 text-sm">{item.name.split('(')[0]}</div><div className="flex items-center gap-2 mt-1"><span className="text-[10px] bg-amber-900/30 text-amber-500 px-1.5 py-0.5 rounded border border-amber-900/50">${item.cp}/kcal</span><span className="text-xs text-stone-500">{item.desc}</span></div></div><div className="text-right"><div className="text-stone-300 font-mono text-sm">${item.displayPrice}</div><div className="text-stone-600 text-xs font-mono">{item.calories} kcal</div></div></div>))}</div>)}</div></div>)}

      <div className="max-w-md mx-auto p-4">
        {activeTab === 'dashboard' && renderDashboard()}
        {activeTab === 'scan' && (<>{!image && !isEditing && (<div className="flex flex-col items-center justify-center h-[60vh] space-y-6"><button onClick={() => fileInputRef.current.click()} className="w-48 h-48 rounded-full bg-stone-900 border-4 border-stone-800 flex flex-col items-center justify-center hover:border-amber-600 transition-all shadow-2xl group"><Camera size={48} className="text-stone-400 mb-2 group-hover:text-amber-400 transition-colors" /><span className="text-stone-400 font-medium group-hover:text-amber-400 transition-colors">æ‹ä¸‹ä¸€ç›¤</span></button><input type="file" accept="image/*" capture="environment" ref={fileInputRef} className="hidden" onChange={handleImageUpload} /><button onClick={startManualInput} className="flex items-center gap-2 text-stone-400 hover:text-amber-400 px-6 py-3 rounded-xl border border-stone-800 hover:bg-stone-900 transition-all"><PenTool size={18} /><span className="font-medium">æ‰‹å‹•è¼¸å…¥</span></button></div>)}{image && !isEditing && !loading && (<div className="space-y-6 animate-fade-in"><div className="relative rounded-2xl overflow-hidden shadow-lg border border-stone-800 group"><img src={image} alt="Food" className="w-full max-h-64 object-cover" /><button onClick={() => setImage(null)} className="absolute top-2 right-2 bg-black/50 p-2 rounded-full text-white"><RotateCcw size={16}/></button></div><button onClick={analyzeImage} className="w-full py-4 rounded-xl font-bold text-lg bg-amber-600 text-white shadow-lg flex items-center justify-center gap-2"><Calculator size={20} /> é–‹å§‹ä¼°åƒ¹</button></div>)}{loading && (<div className="flex flex-col items-center justify-center h-[50vh] space-y-4"><div className="w-12 h-12 border-4 border-stone-800 border-t-amber-600 rounded-full animate-spin"></div><p className="text-stone-400 animate-pulse">AI æ­£åœ¨æ•¸æ•¸...</p></div>)}{isEditing && (<div className="space-y-4 pb-24 animate-fade-in">{image ? (<div className="relative rounded-xl overflow-hidden border border-stone-800"><img src={image} className="w-full object-contain max-h-[50vh]" /><div className="absolute bottom-2 left-1/2 -translate-x-1/2"><span className="bg-black/60 text-white px-3 py-1 rounded-full text-xs backdrop-blur">æœ¬ç›¤åƒ¹å€¼é ä¼° ${calculateTotal(plateItems).price}</span></div></div>) : (<div className="p-4 bg-stone-800 rounded-xl border border-stone-700 text-center mb-2"><p className="text-stone-300 font-bold">ğŸ“ æ‰‹å‹•ç´€éŒ„æ¨¡å¼</p><p className="text-xs text-stone-500 mt-1">ç¸½è¨ˆ: ${calculateTotal(plateItems).price}</p></div>)}<div className="bg-stone-900 rounded-xl border border-stone-800 divide-y divide-stone-800">{plateItems.map((item, idx) => (<div key={idx} className="relative p-3 flex flex-col gap-2"><div className="flex items-center gap-3"><div className="flex-1 relative"><input className="bg-transparent text-stone-200 font-bold text-sm w-full placeholder-stone-600 focus:outline-none focus:border-b border-amber-600" value={item.name} placeholder="è¼¸å…¥èœå..." onChange={(e) => handleNameChange(idx, e.target.value)} onFocus={() => handleNameChange(idx, item.name)} />{activeSuggestionIndex === idx && suggestions.length > 0 && (<div className="absolute top-full left-0 w-full bg-stone-800 border border-stone-700 rounded-lg shadow-2xl z-50 max-h-48 overflow-y-auto mt-1">{suggestions.map((s, sIdx) => (<button key={sIdx} className="w-full text-left p-3 text-xs hover:bg-stone-700 border-b border-stone-700/50 last:border-0 flex justify-between items-center" onMouseDown={(e) => { e.preventDefault(); selectSuggestion(idx, s); }}><div className="font-bold text-stone-200">{s.name}</div><div className="text-right"><div className="text-amber-400">${getDisplayPrice(s)}</div><div className="text-stone-500 text-[10px]">{s.calories} kcal</div></div></button>))}</div>)}</div><div className="flex items-center bg-stone-800 rounded-lg border border-stone-700"><button onClick={() => updateCount(idx, -1)} className="p-2 text-stone-400 hover:text-red-400 hover:bg-red-900/20 rounded-l-lg"><Minus size={14}/></button><span className="w-6 text-center font-mono text-stone-200 text-sm">{item.count}</span><button onClick={() => updateCount(idx, 1)} className="p-2 text-stone-400 hover:text-green-400 hover:bg-green-900/20 rounded-r-lg"><Plus size={14}/></button></div></div><div className="flex flex-wrap gap-2 text-xs"><div className="flex items-center gap-1"><span className="text-stone-500">å¸‚åƒ¹$</span><input type="number" className="bg-stone-800 border border-stone-700 rounded px-2 py-1 w-14 text-amber-400" value={item.price || ''} placeholder="0" onChange={(e) => { const newItems = [...plateItems]; newItems[idx] = {...item, price: Number(e.target.value)}; setPlateItems(newItems); }} /></div><div className="flex items-center gap-1"><span className="text-stone-500">é¤å»³$</span><input type="number" className="bg-stone-800 border border-stone-700 rounded px-2 py-1 w-14 text-amber-400" value={item.restaurantPrice || ''} placeholder="0" onChange={(e) => { const newItems = [...plateItems]; newItems[idx] = {...item, restaurantPrice: Number(e.target.value)}; setPlateItems(newItems); }} /></div><div className="flex items-center gap-1"><input type="number" className="bg-stone-800 border border-stone-700 rounded px-2 py-1 w-14 text-stone-300" value={item.calories || ''} placeholder="0" onChange={(e) => { const newItems = [...plateItems]; newItems[idx] = {...item, calories: Number(e.target.value)}; setPlateItems(newItems); }} /><span className="text-stone-500">kcal</span></div></div><div className="text-xs text-stone-600 text-right">x {item.count} = ${getDisplayPrice(item) * item.count} / {(item.calories || 0) * item.count} kcal</div></div>))}<button onClick={() => setPlateItems([...plateItems, {name: '', price: 0, count: 1, calories: 0, category: 'General'}])} className="w-full p-3 text-xs text-stone-400 hover:bg-stone-800 flex items-center justify-center gap-1"><Plus size={12}/> æ–°å¢é …ç›®</button></div><div className="flex gap-3"><button onClick={() => {setImage(null); setIsEditing(false); setPlateItems([])}} className="flex-1 py-3 rounded-xl border border-stone-700 text-stone-400 text-sm">å–æ¶ˆ</button><button onClick={confirmPlate} className="flex-[2] py-3 rounded-xl bg-green-600 text-white font-bold shadow-lg shadow-green-900/20 flex items-center justify-center gap-2"><Check size={18} /> ç¢ºèªå­˜å…¥</button></div></div>)}</>)}
        {activeTab === 'history' && renderHistory()}
      </div>

      <div className="fixed bottom-0 inset-x-0 bg-stone-950/90 backdrop-blur border-t border-stone-800 p-2 flex justify-around z-40 pb-safe">
        <button onClick={() => setActiveTab('dashboard')} className={`flex flex-col items-center p-2 rounded-xl transition-colors ${activeTab === 'dashboard' ? 'text-amber-500' : 'text-stone-500 hover:text-stone-300'}`}><LayoutDashboard size={24} /><span className="text-[10px] font-bold mt-1">æˆ°æƒ…å®¤</span></button>
        <button onClick={() => setActiveTab('scan')} className={`flex flex-col items-center p-2 rounded-xl transition-colors ${activeTab === 'scan' ? 'text-amber-500' : 'text-stone-500 hover:text-stone-300'}`}><Camera size={24} /><span className="text-[10px] font-bold mt-1">é–‹åƒ</span></button>
        <button onClick={() => setActiveTab('history')} className={`flex flex-col items-center p-2 rounded-xl transition-colors ${activeTab === 'history' ? 'text-amber-500' : 'text-stone-500 hover:text-stone-300'}`}><HistoryIcon size={24} /><span className="text-[10px] font-bold mt-1">ç´€éŒ„</span></button>
      </div>

      <style>{`@keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } } .animate-fade-in { animation: fade-in 0.3s ease-out forwards; } .pb-safe { padding-bottom: env(safe-area-inset-bottom); }`}</style>
    </div>
  );
};

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<NagomiApp />);
    </script>
</body>
</html>
